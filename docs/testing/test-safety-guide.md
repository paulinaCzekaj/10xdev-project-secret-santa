# Test Safety Guide

## Overview

This project implements **multiple layers of protection** to ensure tests **NEVER** run against the production database. All tests are configured to use local Supabase only.

---

## üõ°Ô∏è Protection Layers

### Layer 1: Environment Configuration

**File: `.env.test`**
```env
SUPABASE_URL=http://127.0.0.1:54321  # ‚úÖ Local only
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... # Local key
```

**Purpose**: Dedicated environment file for E2E tests using local Supabase.

**Location**: `/home/arinstreal/Documents/Projects/10xdev-project-secret-santa/.env.test`

**Git Status**: ‚úÖ Ignored (in `.gitignore`)

---

### Layer 2: Playwright Safety Check

**File: `playwright.config.ts`**

**Protection**: Validates environment variables before running E2E tests.

**Location**: Lines 8-22

```typescript
// SAFETY CHECK: Prevent tests from running against production database
const supabaseUrl = process.env.SUPABASE_URL || process.env.PUBLIC_SUPABASE_URL;

if (supabaseUrl?.includes("uiyurwyzsckkkoqthxmv.supabase.co")) {
  console.error("\n‚ùå CRITICAL ERROR: E2E tests are configured to use PRODUCTION database!");
  console.error(`   Detected URL: ${supabaseUrl}`);
  console.error(`   Expected: http://127.0.0.1:54321 (local Supabase)`);
  console.error("\n   Tests MUST NOT run against production!");
  console.error("   Please check your .env.test file.\n");
  process.exit(1);
}

console.log("‚úÖ E2E Test Safety Check: Using local Supabase");
console.log(`   SUPABASE_URL: ${supabaseUrl || "not set"}\n`);
```

**What it does**:
1. Reads `.env.test` via dotenv (line 6)
2. Checks if any Supabase URL contains production reference
3. **Terminates tests immediately** if production URL is detected
4. Prints confirmation when using local Supabase

**Test Output**:
```
‚úÖ E2E Test Safety Check: Using local Supabase
   SUPABASE_URL: http://127.0.0.1:54321
```

---

### Layer 3: Vitest Safety Check

**File: `vitest.setup.ts`**

**Protection**: Validates environment before running unit tests.

**Location**: Lines 5-18

```typescript
// SAFETY CHECK: Ensure unit tests never use production database
const currentSupabaseUrl = process.env.PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;
if (currentSupabaseUrl?.includes("uiyurwyzsckkkoqthxmv.supabase.co")) {
  console.error("\n‚ùå CRITICAL ERROR: Unit tests detected PRODUCTION database URL!");
  console.error(`   Found: ${currentSupabaseUrl}`);
  console.error("   Unit tests must use mocked Supabase client.\n");
  throw new Error("Unit tests cannot run against production database");
}

// Mock Supabase environment variables for tests
process.env.PUBLIC_SUPABASE_URL = "https://test.supabase.co";
process.env.PUBLIC_SUPABASE_ANON_KEY = "test-anon-key";

console.log("‚úÖ Vitest Safety Check: Using mocked Supabase URLs");
```

**What it does**:
1. Checks for production URL in environment
2. **Throws error** if production URL is detected
3. Overrides environment with mocked Supabase URLs
4. Ensures unit tests always use mocks, never real database

**Test Output**:
```
‚úÖ Vitest Safety Check: Using mocked Supabase URLs
```

---

### Layer 4: E2E Development Server Script

**File: `scripts/dev-e2e.js`**

**Protection**: Ensures E2E dev server uses `.env.test` configuration.

**How it works**:
1. Validates `.env.test` exists
2. **Checks for production URLs** in `.env.test`
3. **Verifies local Supabase URL** (127.0.0.1:54321) is present
4. Creates temporary `.env.local` from `.env.test` (Astro prioritizes .env.local)
5. Starts Astro dev server
6. **Auto-cleans** `.env.local` on exit

**Usage**:
```bash
npm run dev:e2e  # Uses scripts/dev-e2e.js
```

**Output**:
```
=== E2E Development Server ===

‚úÖ Safety Check Passed: .env.test is using local Supabase
‚úÖ Environment: E2E test mode

üìù Creating temporary .env.local from .env.test...
‚úÖ Temporary .env.local created

üöÄ Starting Astro development server...
```

**Safety Features**:
- ‚ùå Exits with error if `.env.test` not found
- ‚ùå Exits with error if production URL detected in `.env.test`
- ‚ö†Ô∏è  Warns if local URL not found in `.env.test`
- üßπ Auto-removes `.env.local` on server stop (SIGINT, SIGTERM, exit)

---

### Layer 5: Source Code Verification

**Protection**: No hardcoded production URLs in source code.

**Verified directories**:
- `src/**/*`
- `e2e/**/*`

**Search performed**:
```bash
grep -r "uiyurwyzsckkkoqthxmv.supabase.co" src/ e2e/
```

**Result**: ‚úÖ No hardcoded production URLs found

---

## üîí Git Protection

**File: `.gitignore`**

Protected environment files:
```gitignore
.env
.env.production
.env.test
.env.local  # Auto-generated by dev-e2e.js
```

**Purpose**: Prevents accidental commit of:
- Production credentials
- Test credentials
- Temporary environment files

---

## ‚úÖ Running Tests Safely

### E2E Tests (Playwright)

```bash
# Start E2E dev server (uses .env.test)
npm run dev:e2e

# Run E2E tests (in another terminal)
npm run test:e2e

# Run E2E tests with UI
npm run test:e2e:ui

# Debug E2E tests
npm run test:e2e:debug
```

**What happens**:
1. `dev:e2e` runs `scripts/dev-e2e.js`
2. Script validates `.env.test` doesn't contain production URL
3. Creates `.env.local` from `.env.test`
4. Starts Astro dev server on port 3000
5. Playwright reads `.env.test` for test credentials
6. Playwright validates Supabase URL before running tests
7. Tests execute against **local Supabase only** (127.0.0.1:54321)

### Unit Tests (Vitest)

```bash
# Run all unit tests
npm run test

# Run tests in watch mode
npm run test:watch

# Run tests with UI
npm run test:ui

# Run tests with coverage
npm run test:coverage
```

**What happens**:
1. Vitest loads `vitest.setup.ts`
2. Setup file validates no production URL in environment
3. Mocks Supabase URLs to `https://test.supabase.co`
4. Tests execute with **mocked Supabase client** (no real database)

---

## üö® What Happens if Production URL is Detected?

### Playwright (E2E tests):

```
‚ùå CRITICAL ERROR: E2E tests are configured to use PRODUCTION database!
   Detected URL: https://uiyurwyzsckkkoqthxmv.supabase.co
   Expected: http://127.0.0.1:54321 (local Supabase)

   Tests MUST NOT run against production!
   Please check your .env.test file.

Process exited with code 1
```

**Action**: Tests **terminate immediately** before any test runs.

### Vitest (Unit tests):

```
‚ùå CRITICAL ERROR: Unit tests detected PRODUCTION database URL!
   Found: https://uiyurwyzsckkkoqthxmv.supabase.co
   Unit tests must use mocked Supabase client.

Error: Unit tests cannot run against production database
```

**Action**: Test suite **throws error** before any test runs.

### dev-e2e.js Script:

```
‚ùå CRITICAL ERROR: .env.test contains PRODUCTION database URL!
   File: /path/to/.env.test
   Found: uiyurwyzsckkkoqthxmv.supabase.co
   Expected: http://127.0.0.1:54321 (local Supabase)

   E2E tests MUST NOT run against production!
   Please update .env.test to use local Supabase.

Process exited with code 1
```

**Action**: Server **fails to start**, preventing any tests from running.

---

## üîß Troubleshooting

### Problem: "E2E tests are configured to use PRODUCTION database"

**Solution**:
1. Check `.env.test` file
2. Ensure `SUPABASE_URL=http://127.0.0.1:54321`
3. Ensure no production URL (`uiyurwyzsckkkoqthxmv.supabase.co`) is present

### Problem: "Unit tests detected PRODUCTION database URL"

**Solution**:
1. Check your shell environment: `echo $PUBLIC_SUPABASE_URL`
2. Ensure no production environment variables are set globally
3. Restart your terminal/IDE

### Problem: ".env.test file not found"

**Solution**:
1. Create `.env.test` from `.env.example`:
   ```bash
   cp .env.example .env.test
   ```
2. Update URLs to local Supabase:
   ```env
   SUPABASE_URL=http://127.0.0.1:54321
   SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```

### Problem: Tests fail with connection errors

**Solution**:
1. Ensure local Supabase is running:
   ```bash
   supabase start
   ```
2. Check Supabase is accessible:
   ```bash
   curl http://127.0.0.1:54321
   ```

---

## üìã Safety Checklist

Before running tests, verify:

- [ ] Local Supabase is running (`supabase status`)
- [ ] `.env.test` contains local URLs only
- [ ] `.env` contains local URLs (for dev work)
- [ ] No global environment variables point to production
- [ ] Recent backup of production exists (`npm run backup:production:api`)

---

## üéØ Summary

**Protection Status**: ‚úÖ **5 Layers of Protection Active**

| Layer | Status | Description |
|-------|--------|-------------|
| 1. `.env.test` | ‚úÖ Active | Dedicated test environment file with local URLs |
| 2. Playwright Check | ‚úÖ Active | Validates URLs before E2E tests run |
| 3. Vitest Check | ‚úÖ Active | Validates URLs before unit tests run |
| 4. dev-e2e Script | ‚úÖ Active | Validates and enforces `.env.test` for dev server |
| 5. Source Code | ‚úÖ Verified | No hardcoded production URLs |

**Production Database Protection**: üõ°Ô∏è **Fully Protected**

Tests **cannot** run against production database due to multiple validation layers. Any attempt to use production URLs will:
1. **Fail validation** in playwright.config.ts or vitest.setup.ts
2. **Terminate immediately** with clear error message
3. **Prevent any data modifications** to production

---

## üìö Related Documentation

- [Environment Configuration Guide](../developer/environments.md)
- [Testing Guide](guide.md)
- [Test Coverage Analysis](coverage-analysis.md)

---

**Last Updated**: 2025-11-15
**Version**: 1.0.0
