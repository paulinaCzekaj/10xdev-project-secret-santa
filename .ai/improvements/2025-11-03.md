# Secret Santa - Analiza Projektu i Plan Rozwoju

**Data analizy:** 2025-11-03
**Analizowane przez:** Claude Code (Sonnet 4.5)
**Wersja projektu:** v1.0 (MVP)

---

## Spis treÅ›ci

1. [Streszczenie wykonawcze](#streszczenie-wykonawcze)
2. [Analiza obecnego stanu](#analiza-obecnego-stanu)
3. [Roadmapa rozwoju (3-6 miesiÄ™cy)](#roadmapa-rozwoju)
4. [Metryki sukcesu](#metryki-sukcesu)
5. [Rekomendacje](#rekomendacje)

---

## Streszczenie wykonawcze

### Status projektu: **85-90% kompletny MVP** âœ…

Aplikacja Secret Santa to dobrze zaimplementowane narzÄ™dzie webowe do organizacji wymiany prezentÃ³w, zbudowane w oparciu o nowoczesny stack technologiczny (Astro 5, React 19, TypeScript, Supabase). Projekt speÅ‚nia wszystkie wymagania z PRD (Product Requirements Document) dla zakresu MVP, z wyrÃ³Å¼niajÄ…cym siÄ™ algorytmem losowania i przemyÅ›lanym doÅ›wiadczeniem uÅ¼ytkownika.

### Kluczowe osiÄ…gniÄ™cia

- âœ… **100% funkcjonalnoÅ›ci MVP** z PRD zaimplementowane
- âœ… **Zaawansowany algorytm losowania** z backtrackingiem i walidacjÄ…
- âœ… **Dual-mode access** dla uÅ¼ytkownikÃ³w zalogowanych i anonimowych
- âœ… **Responsywny design** z animacjami i auto-save
- âœ… **Solidna architektura** z service layer pattern

### Obszary wymagajÄ…ce uwagi

- âš ï¸ **RLS wyÅ‚Ä…czone** w bazie danych (ryzyko bezpieczeÅ„stwa)
- âš ï¸ **Testy nieaktywne** w CI/CD pipeline
- âš ï¸ **Luki w pokryciu testami** (API routes, hooks)

---

## Analiza obecnego stanu

### 1. Implementacja wzglÄ™dem PRD

#### âœ… Zaimplementowane User Stories (100% z MVP scope)

| ID | Feature | Status | Uwagi |
|---|---|---|---|
| US-001 | Rejestracja uÅ¼ytkownika | âœ… 100% | PeÅ‚na walidacja, Supabase Auth |
| US-002 | Logowanie | âœ… 100% | Email + hasÅ‚o, error handling |
| US-003 | Reset hasÅ‚a | âœ… 100% | Formularz + email flow |
| US-004 | Wylogowanie | âœ… 100% | Widoczny przycisk w UI |
| US-005 | Tworzenie grupy | âœ… 100% | Nazwa, budÅ¼et (PLN), data koÅ„ca |
| US-006 | Dodawanie uczestnikÃ³w | âœ… 100% | ImiÄ™ + opcjonalny email, unique validation |
| US-007 | ReguÅ‚y wykluczeÅ„ | âœ… 100% | Jednokierunkowe, CRUD operations |
| US-008 | Losowanie | âœ… 100% | Walidacja (min 3), backtracking algorithm |
| US-009 | Usuwanie grupy | âœ… 100% | Confirmation modal, cascade delete |
| US-010 | Dashboard | âœ… 100% | Grupy utworzone + doÅ‚Ä…czone |
| US-011 | Listy Å¼yczeÅ„ | âœ… 100% | Auto-save, URL linking, editable do end date |
| US-012 | Wyniki (zalogowany) | âœ… 100% | Animated reveal, wishlist display |
| US-013 | Wyniki (anonimowy) | âœ… 100% | Unique token links, tracking |

#### âŒ WyÅ‚Ä…czone z MVP (zgodnie z PRD sekcja 4.2)

- Email notifications
- System zaproszeÅ„ (invite links)
- Czat grupowy
- Edycja po losowaniu
- Integracje zewnÄ™trzne (Amazon, etc.)
- Zaawansowane role (wspÃ³Å‚organizator)
- Multi-currency

---

### 2. Architektura techniczna

#### Stack technologiczny

```
Frontend:
- Astro 5.13.7 (SSR + Islands)
- React 19.1.1 (UI components)
- TypeScript 5 (strict mode)
- Tailwind CSS 4.1.13
- Shadcn/ui (Radix UI primitives)

Backend:
- Supabase (PostgreSQL + Auth)
- API Routes (Astro endpoints)
- Service Layer Pattern

Testing:
- Vitest 3.2.4 (unit tests)
- Playwright 1.56.0 (E2E)
- GitHub Actions (CI/CD)

Deployment:
- Cloudflare Pages
- Docker support
```

#### Struktura kodu

```
/src
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ auth/           # Formularze uwierzytelniania
â”‚   â”œâ”€â”€ dashboard/      # Widok pulpitu
â”‚   â”œâ”€â”€ forms/          # Formularze grup
â”‚   â”œâ”€â”€ group/          # ZarzÄ…dzanie grupÄ…
â”‚   â”œâ”€â”€ result/         # Wyniki i reveal
â”‚   â””â”€â”€ ui/             # Shadcn components
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ services/       # Business logic layer
â”‚   â”‚   â”œâ”€â”€ draw.service.ts      # â­ Algorytm losowania
â”‚   â”‚   â”œâ”€â”€ group.service.ts
â”‚   â”‚   â”œâ”€â”€ participant.service.ts
â”‚   â”‚   â””â”€â”€ wishlist.service.ts
â”‚   â””â”€â”€ utils/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ api/            # API endpoints
â”‚   â”œâ”€â”€ groups/         # Group management pages
â”‚   â””â”€â”€ results/        # Result viewing
â”œâ”€â”€ hooks/              # Custom React hooks
â””â”€â”€ types.ts            # TypeScript definitions
```

---

### 3. Mocne strony projektu

#### ğŸ† WyrÃ³Å¼niajÄ…ce siÄ™ elementy

**1. Zaawansowany algorytm losowania**
- Lokalizacja: `/src/lib/services/draw.service.ts`
- **Backtracking z randomizacjÄ…** - zapewnia losowoÅ›Ä‡ przy speÅ‚nieniu constraints
- **Walidacja feasibility** - sprawdza czy draw jest moÅ¼liwy przed rozpoczÄ™ciem
- **Timeout protection** - 15s limit dla bardzo duÅ¼ych grup
- **Kompleksowe testy**: 3 pliki testowe (draw.service.test.ts, cross-pairs, final-test)
- ObsÅ‚uga edge cases: samodzielne wykluczenia, circular dependencies, impossible draws

**2. User Experience**
- **Animated gift reveal** z confetti (GiftBox.tsx)
- **Auto-save wishlists** z 2s debounce
- **URL auto-linking** w wishlistach
- **8 typÃ³w error states** z recovery actions
- **localStorage persistence** dla stanu reveal
- **Responsive design** mobile-first

**3. Dual Access System**
- UÅ¼ytkownicy zalogowani: przez dashboard â†’ groups â†’ result
- UÅ¼ytkownicy anonimowi: unique token link `/results/[token]`
- Tracking otwarÄ‡: `result_viewed_at` timestamp
- Identical UX dla obu Å›cieÅ¼ek

**4. Clean Architecture**
- Service layer oddzielony od UI
- Custom hooks dla reusable logic
- Type safety z TypeScript strict mode
- Consistent error handling patterns

---

### 4. SÅ‚aboÅ›ci i technical debt

#### ğŸ”´ Krytyczne (wymagajÄ… natychmiastowej uwagi)

**1. Row Level Security wyÅ‚Ä…czone**
- **Lokalizacja**: Wszystkie pliki w `/supabase/migrations/`
- **Problem**: Komentarz `-- DISABLED FOR DEVELOPMENT` w kaÅ¼dej migracji
- **Ryzyko**: Brak autoryzacji na poziomie bazy danych
- **Impact**: Potencjalny dostÄ™p do cudzych danych przez API
- **RozwiÄ…zanie**: OdkomentowaÄ‡ RLS policies przed produkcjÄ…

**2. Testy wyÅ‚Ä…czone w CI/CD**
- **Lokalizacja**: `.github/workflows/ci.yml` linie 40-104
- **Problem**: Unit i E2E testy zakomentowane
- **Ryzyko**: Broken code moÅ¼e trafiÄ‡ do main branch
- **Impact**: Brak automatycznej walidacji zmian
- **RozwiÄ…zanie**: OdkomentowaÄ‡ i naprawiÄ‡ failing tests

#### ğŸŸ¡ Wysokie (powinny byÄ‡ rozwiÄ…zane przed launch)

**3. Luki w pokryciu testami**
- API routes: **0% pokrycie** (brak testÃ³w dla endpointÃ³w)
- Custom hooks: **~30% pokrycie** (tylko niektÃ³re przetestowane)
- Form validation: **brak E2E** dla edge cases
- **Cel z PRD**: 70% coverage - obecnie nieznany %

**4. Brak coverage reportingu**
- Nie ma metryk pokrycia kodu
- Nie moÅ¼na Å›ledziÄ‡ postÄ™pu
- Brak enforcement thresholds

**5. Hardcoded credentials w testach**
- **Lokalizacja**: `/e2e/groups/create-group-flow-pom.spec.ts:19-20`
- **Problem**: Test email/password w kodzie
- **RozwiÄ…zanie**: UÅ¼yÄ‡ tylko zmiennych Å›rodowiskowych

#### ğŸŸ¢ Åšrednie (nice-to-have)

**6. Deprecated code**
- `countRemainingOptions()` w draw.service.ts - unused (linia 295)
- MoÅ¼na usunÄ…Ä‡ dla clean up

**7. Console.log w production**
- Error logging przez console.log
- Brak structured logging
- RozwiÄ…zanie: Winston/Pino lub Sentry

**8. Brak monitoringu**
- Zero observability w production
- Brak error tracking
- Brak performance metrics

---

### 5. User Journey Analysis

#### ÅšcieÅ¼ka 1: Organizator grupy (100% funkcjonalna)

```
1. Rejestracja/Login âœ…
2. Dashboard â†’ "UtwÃ³rz grupÄ™" âœ…
3. WypeÅ‚nienie formularza (nazwa, budÅ¼et, data) âœ…
4. Dodanie uczestnikÃ³w (min. 3) âœ…
   - ImiÄ™ + opcjonalny email
   - Walidacja unikalnoÅ›ci email
5. Definicja wykluczeÅ„ (opcjonalnie) âœ…
   - "A nie moÅ¼e wylosowaÄ‡ B"
   - Lista wykluczeÅ„ z opcjÄ… usuwania
6. Walidacja moÅ¼liwoÅ›ci losowania âœ…
   - System sprawdza czy draw jest wykonalny
7. Potwierdzenie i wykonanie draw âœ…
   - Modal z ostrzeÅ¼eniem o nieodwracalnoÅ›ci
   - Algorytm wykonuje losowanie
8. Przekierowanie do wyniku âœ…
9. Zobacz kogo wylosujesz + ich wishlist âœ…
10. Edytuj swojÄ… wishlist âœ…
```

**Pain points**: Brak
**Opportunities**: Email notifications, invite links

#### ÅšcieÅ¼ka 2: Uczestnik zarejestrowany

```
1. Login âœ…
2. Dashboard â†’ sekcja "Grupy do ktÃ³rych naleÅ¼Ä™" âœ…
3. KlikniÄ™cie w grupÄ™ â†’ przekierowanie do result âœ…
4. Animated reveal (jeÅ›li pierwszy raz) âœ…
5. Zobacz przydzielonÄ… osobÄ™ + wishlist âœ…
6. Edytuj swojÄ… wishlist âœ…
```

**Pain points**: Brak powiadomienia o losowaniu
**Opportunities**: Email "Your Secret Santa draw is ready!"

#### ÅšcieÅ¼ka 3: Uczestnik anonimowy

```
1. Otrzymanie unique link (np. przez WhatsApp) âœ…
2. Otwarcie linku bez logowania âœ…
3. Animated reveal âœ…
4. Zobacz przydzielonÄ… osobÄ™ + wishlist âœ…
5. Edytuj swojÄ… wishlist âœ…
6. Tracking: result_viewed_at zapisany âœ…
```

**Pain points**: Brak
**UX Highlight**: Doskonale zaprojektowana Å›cieÅ¼ka

---

### 6. Metryki z PRD

#### Business Metrics (PRD sekcja 6.1)

| Metryka | Target | Status | Jak mierzyÄ‡ |
|---|---|---|---|
| Result view rate | 100% | âœ… Trackable | `participants.result_viewed_at` + API tracking |
| User activation | 50% | â“ Unknown | Wymaga analytics implementation |

#### Technical Metrics (PRD sekcja 6.2)

| Metryka | Target | Status |
|---|---|---|
| Core scenario functional | 100% | âœ… **Pass** |
| Draw logic tested | 100% | âœ… **Extensive** (3 test files) |
| CI/CD operational | Auto-run | âš ï¸ **Partial** (tests disabled) |
| Academic success | Positive grade | âœ… **Ready** |

---

## Roadmapa rozwoju

### Kontekst i zaÅ‚oÅ¼enia

**Priorytet uÅ¼ytkownika:**
- ğŸ¯ **Cel gÅ‚Ã³wny**: RozwÃ³j funkcjonalnoÅ›ci (nowe features)
- â±ï¸ **Horyzont**: DÅ‚ugoterminowy (3-6 miesiÄ™cy)
- ğŸ‘¥ **UÅ¼ycie**: Osobiste/Rodzina/Przyjaciele (maÅ‚e-Å›rednie grupy)
- â­ **Top priorities**: Email notifications, Invite system, Re-draw capability

---

## ğŸš€ FAZA 1: Fundamenty & BezpieczeÅ„stwo
**Timeline:** TydzieÅ„ 1-2
**Priorytet:** ğŸ”´ KRYTYCZNY

### Cele
Przygotowanie solidnej podstawy przed dodawaniem nowych funkcji. Eliminacja technical debt i ryzyk bezpieczeÅ„stwa.

### Zadania

#### 1.1 WÅ‚Ä…czenie Row Level Security (RLS)

**Lokalizacja:** `/supabase/migrations/*.sql`

**Zmiany:**
```sql
-- W kaÅ¼dej migracji odkomentowaÄ‡:
ALTER TABLE groups ENABLE ROW LEVEL SECURITY;
ALTER TABLE participants ENABLE ROW LEVEL SECURITY;
ALTER TABLE exclusion_rules ENABLE ROW LEVEL SECURITY;
ALTER TABLE assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE wishes ENABLE ROW LEVEL SECURITY;

-- Oraz wszystkie CREATE POLICY statements
```

**Policies do zaimplementowania:**
- `groups`: tylko creator moÅ¼e edytowaÄ‡/usuwaÄ‡
- `participants`: tylko czÅ‚onkowie grupy widzÄ… uczestnikÃ³w
- `assignments`: tylko giver widzi swÃ³j assignment
- `exclusion_rules`: tylko creator moÅ¼e zarzÄ…dzaÄ‡
- `wishes`: owner moÅ¼e edytowaÄ‡, wszyscy w grupie czytaÄ‡

**Testing:**
- Unit tests dla kaÅ¼dej policy
- E2E test: prÃ³ba dostÄ™pu do cudzych danych (powinien fail)

#### 1.2 Aktywacja testÃ³w w CI/CD

**Lokalizacja:** `.github/workflows/ci.yml`

**Zmiany:**
```yaml
# OdkomentowaÄ‡ linie 40-65 (unit tests)
- name: Run unit tests
  run: npm run test

# OdkomentowaÄ‡ linie 68-104 (E2E tests)
- name: Run E2E tests
  run: npx playwright test
```

**Fix failing tests:**
- PrzeanalizowaÄ‡ dlaczego testy byÅ‚y wyÅ‚Ä…czone
- NaprawiÄ‡ broken tests
- DodaÄ‡ `--coverage` flag

#### 1.3 UzupeÅ‚nienie pokrycia testami

**Nowe testy do dodania:**

1. **API Routes tests** (`/src/pages/api/**/*.test.ts`)
   - `POST /api/groups` - create group
   - `GET /api/groups/:id` - authorization checks
   - `POST /api/groups/:id/draw` - draw execution
   - `DELETE /api/groups/:id` - cascade deletion

2. **E2E flows** (`/e2e/`)
   - `draw-execution.spec.ts` - peÅ‚ny flow losowania
   - `result-viewing.spec.ts` - authenticated + anonymous
   - `wishlist-editing.spec.ts` - auto-save, URL linking

3. **Custom Hooks tests**
   - `useGroupData.test.ts`
   - `useDraw.test.ts`
   - `useResultData.test.ts`

**Coverage target:** 70% (zgodnie z TESTING.md)

#### 1.4 Coverage reporting

**Setup:**
```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html', 'lcov'],
      lines: 70,
      functions: 70,
      branches: 70,
      statements: 70,
      exclude: [
        'node_modules/',
        'e2e/',
        '**/*.config.ts',
      ]
    }
  }
})
```

**CI integration:**
- Upload coverage do Codecov/Coveralls
- DodaÄ‡ badge do README.md
- Fail CI jeÅ›li coverage < 70%

### Deliverables
- âœ… RLS wÅ‚Ä…czone i przetestowane
- âœ… Wszystkie testy przechodzÄ… w CI
- âœ… Coverage â‰¥70% dla core logic
- âœ… Coverage badge w README

### Success Criteria
- Zero failed tests w CI/CD
- PrÃ³ba unauthorized access zwraca 403
- Coverage report dostÄ™pny publicznie

---

## ğŸ“§ FAZA 2: System PowiadomieÅ„ Email
**Timeline:** TydzieÅ„ 3-6
**Priorytet:** ğŸŸ  WYSOKI

### Cele
Automatyzacja komunikacji z uczestnikami, redukcja manual work dla organizatorÃ³w, zwiÄ™kszenie engagement.

### 2.1 Infrastruktura Email

#### WybÃ³r providera

**Opcje:**
1. **Resend** (rekomendowane dla maÅ‚ych projektÃ³w)
   - Darmowy tier: 3,000 emails/miesiÄ…c
   - API podobne do Postmark
   - React Email templates support
   - Setup: ~1h

2. **SendGrid** (dla wiÄ™kszej skali)
   - Darmowy tier: 100 emails/dzieÅ„
   - Bardziej rozbudowany
   - Setup: ~2h

**Decyzja:** Resend (prostota + React Email)

#### Setup

```bash
npm install resend react-email
```

**Struktura:**
```
/src/emails/
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ WelcomeEmail.tsx
â”‚   â”œâ”€â”€ DrawCompletedEmail.tsx
â”‚   â”œâ”€â”€ ResultLinkEmail.tsx
â”‚   â”œâ”€â”€ ReminderEmail.tsx
â”‚   â””â”€â”€ WishlistReminderEmail.tsx
â”œâ”€â”€ services/
â”‚   â””â”€â”€ email.service.ts
â””â”€â”€ utils/
    â””â”€â”€ email-formatter.ts
```

#### Environment variables

```env
RESEND_API_KEY=re_xxxxx
FROM_EMAIL=noreply@secretsanta.app
SUPPORT_EMAIL=support@secretsanta.app
```

### 2.2 Typy powiadomieÅ„

#### 1. Welcome Email (po dodaniu do grupy)

**Trigger:** `POST /api/groups/:id/participants`

**Szablon:** `WelcomeEmail.tsx`
```tsx
<Email>
  <Heading>ğŸ ZostaÅ‚eÅ› dodany do Secret Santa!</Heading>
  <Text>
    {participant.name}, {creator.name} dodaÅ‚ CiÄ™ do grupy "{group.name}".
  </Text>
  <Section>
    <Text>ğŸ“… Data wydarzenia: {group.end_date}</Text>
    <Text>ğŸ’° BudÅ¼et: {group.budget} PLN</Text>
  </Section>
  <Button href={wishlistLink}>Dodaj swojÄ… listÄ™ Å¼yczeÅ„</Button>
  <Text>Losowanie zostanie przeprowadzone przez organizatora.</Text>
</Email>
```

**Kiedy wysÅ‚aÄ‡:**
- JeÅ›li participant ma email
- Natychmiast po dodaniu
- Retry 3x w przypadku failure

#### 2. Draw Completed Email

**Trigger:** `POST /api/groups/:id/draw` (sukces)

**Szablon:** `DrawCompletedEmail.tsx`
```tsx
<Email>
  <Heading>ğŸ‰ Losowanie zakoÅ„czone!</Heading>
  <Text>
    Dowiedz siÄ™, komu kupisz prezent w grupie "{group.name}".
  </Text>
  <Button href={resultLink}>Zobacz swÃ³j wynik</Button>
  <Text>ğŸ’° BudÅ¼et: {group.budget} PLN</Text>
  <Text>ğŸ“… Data wydarzenia: {group.end_date}</Text>
</Email>
```

**Recipients:**
- Wszyscy participants
- RÃ³Å¼ne linki dla zalogowanych vs anonimowych

#### 3. Result Link Email (dla niezarejestrowanych)

**Trigger:** `POST /api/groups/:id/draw` (dla participants bez konta)

**Szablon:** `ResultLinkEmail.tsx`
```tsx
<Email>
  <Heading>TwÃ³j unikalny link do wyniku</Heading>
  <Text>{participant.name}, oto TwÃ³j prywatny link:</Text>
  <Button href={tokenLink}>OtwÃ³rz wynik</Button>
  <Text>âš ï¸ Nie udostÄ™pniaj tego linku nikomu - jest tylko dla Ciebie!</Text>
  <Text>Link jest waÅ¼ny przez 1 rok.</Text>
</Email>
```

#### 4. Reminder Email (3 dni przed event end)

**Trigger:** Cron job (daily check)

**Szablon:** `ReminderEmail.tsx`
```tsx
<Email>
  <Heading>â° Secret Santa juÅ¼ za 3 dni!</Heading>
  <Text>
    Przypominamy o zbliÅ¼ajÄ…cym siÄ™ wydarzeniu "{group.name}".
  </Text>
  <Text>Komu kupujesz prezent: <strong>{recipient.name}</strong></Text>
  <Button href={wishlistLink}>Zobacz listÄ™ Å¼yczeÅ„</Button>
</Email>
```

**Warunki:**
- Tylko jeÅ›li event_end_date za 3 dni
- Tylko uczestnicy ktÃ³rzy zobaczyli wynik
- Max 1 email (check sent_reminder flag)

#### 5. Wishlist Reminder (pusta wishlist)

**Trigger:** Cron job (2 dni po draw)

**Szablon:** `WishlistReminderEmail.tsx`
```tsx
<Email>
  <Heading>ğŸ“ Nie zapomniij o swojej liÅ›cie Å¼yczeÅ„!</Heading>
  <Text>
    ZauwaÅ¼yliÅ›my, Å¼e jeszcze nie dodaÅ‚eÅ› listy Å¼yczeÅ„ w grupie "{group.name}".
  </Text>
  <Text>PomÃ³Å¼ osobie, ktÃ³ra CiÄ™ wylosowaÅ‚a - podpowiedz co chciaÅ‚byÅ› dostaÄ‡!</Text>
  <Button href={editWishlistLink}>Dodaj listÄ™ Å¼yczeÅ„</Button>
</Email>
```

**Warunki:**
- Wishlist pusta lub < 20 znakÃ³w
- Draw zakoÅ„czony >48h temu
- Max 1 reminder

### 2.3 Email Service Implementation

**Lokalizacja:** `/src/lib/services/email.service.ts`

```typescript
import { Resend } from 'resend';
import { WelcomeEmail } from '@/emails/templates/WelcomeEmail';

const resend = new Resend(import.meta.env.RESEND_API_KEY);

export const emailService = {
  async sendWelcomeEmail(participant, group, creator) {
    try {
      const { data, error } = await resend.emails.send({
        from: import.meta.env.FROM_EMAIL,
        to: participant.email,
        subject: `ğŸ Zaproszenie do Secret Santa: ${group.name}`,
        react: WelcomeEmail({ participant, group, creator }),
      });

      if (error) {
        console.error('Email send failed:', error);
        // Log to monitoring service
        return { success: false, error };
      }

      // Log successful send
      await logEmailSent({
        participantId: participant.id,
        type: 'welcome',
        sentAt: new Date(),
        messageId: data.id,
      });

      return { success: true, messageId: data.id };
    } catch (err) {
      console.error('Email service error:', err);
      return { success: false, error: err };
    }
  },

  async sendDrawCompletedEmail(participant, group, resultLink) {
    // Similar implementation
  },

  // ... inne metody
};
```

### 2.4 Email Preferences (User Settings)

**Nowa tabela:** `email_preferences`

```sql
CREATE TABLE email_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  participant_id UUID REFERENCES participants(id) ON DELETE CASCADE,

  -- Preferences
  welcome_emails BOOLEAN DEFAULT true,
  draw_completed_emails BOOLEAN DEFAULT true,
  reminder_emails BOOLEAN DEFAULT true,
  wishlist_reminder_emails BOOLEAN DEFAULT true,

  -- Compliance
  unsubscribed_at TIMESTAMPTZ,
  unsubscribe_token TEXT UNIQUE,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**UI:** `/src/components/settings/EmailPreferences.tsx`
- Toggle dla kaÅ¼dego typu emaila
- "Wypisz siÄ™ ze wszystkich" button
- Opt-out link w kaÅ¼dym emailu

### 2.5 Cron Jobs (Email automation)

**Opcje:**
1. **Supabase Edge Functions** + pg_cron (rekomendowane)
2. **GitHub Actions** scheduled workflows
3. **Vercel Cron** (jeÅ›li hosting na Vercel)

**Setup z Supabase:**

```typescript
// supabase/functions/send-reminders/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';

serve(async (req) => {
  // Run daily at 9 AM
  const groupsEndingSoon = await getGroupsEndingIn3Days();

  for (const group of groupsEndingSoon) {
    const participants = await getParticipantsWithResults(group.id);

    for (const p of participants) {
      if (!p.reminder_sent && p.email) {
        await emailService.sendReminderEmail(p, group);
        await markReminderSent(p.id);
      }
    }
  }

  return new Response('OK', { status: 200 });
});
```

**Schedule:**
```sql
-- W Supabase dashboard: Database â†’ Cron Jobs
SELECT cron.schedule(
  'send-daily-reminders',
  '0 9 * * *', -- Daily at 9 AM
  $$ SELECT net.http_post(
    url := 'https://your-project.supabase.co/functions/v1/send-reminders',
    headers := '{"Authorization": "Bearer YOUR_ANON_KEY"}'::jsonb
  ) $$
);
```

### 2.6 Testing

**Unit tests:**
```typescript
// email.service.test.ts
describe('emailService', () => {
  it('sends welcome email with correct data', async () => {
    const result = await emailService.sendWelcomeEmail(
      mockParticipant,
      mockGroup,
      mockCreator
    );

    expect(result.success).toBe(true);
    expect(resend.emails.send).toHaveBeenCalledWith(
      expect.objectContaining({
        to: mockParticipant.email,
        subject: expect.stringContaining(mockGroup.name),
      })
    );
  });

  it('handles email send failure gracefully', async () => {
    vi.mocked(resend.emails.send).mockRejectedValue(new Error('API error'));

    const result = await emailService.sendWelcomeEmail(...);

    expect(result.success).toBe(false);
    expect(result.error).toBeDefined();
  });
});
```

**E2E test:**
```typescript
// e2e/email-notifications.spec.ts
test('user receives draw completed email', async ({ page, mailhog }) => {
  // Setup: create group, add participants, execute draw

  // Check email was sent
  const emails = await mailhog.getMessages();
  const drawEmail = emails.find(e =>
    e.subject.includes('Losowanie zakoÅ„czone')
  );

  expect(drawEmail).toBeDefined();
  expect(drawEmail.to).toBe(participant.email);

  // Verify link in email works
  const resultLink = extractLink(drawEmail.html);
  await page.goto(resultLink);

  await expect(page.locator('h1')).toContainText('TwÃ³j wynik');
});
```

### 2.7 Monitoring & Analytics

**Metryki do Å›ledzenia:**
- Email delivery rate (sent / total)
- Open rate (requires pixel tracking)
- Click-through rate (link clicks)
- Bounce rate
- Unsubscribe rate

**Dashboard:** Resend analytics (built-in)

### Deliverables FAZA 2
- âœ… 5 typÃ³w email templates w React
- âœ… Email service z retry logic
- âœ… Email preferences UI
- âœ… Cron jobs dla automated emails
- âœ… Compliance (unsubscribe links)
- âœ… Tests (unit + E2E)
- âœ… Monitoring dashboard

### Success Criteria
- >95% email delivery rate
- <1% bounce rate
- Users can opt-out easily
- Zero email-related bugs in production

---

## ğŸ”— FAZA 3: System ZaproszeÅ„ (Invite Links)
**Timeline:** TydzieÅ„ 7-10
**Priorytet:** ğŸŸ  WYSOKI

### Cele
UmoÅ¼liwienie uczestnikom samodzielnego doÅ‚Ä…czania do grup, redukcja manual work dla organizatorÃ³w, Å‚atwiejsze skalowanie grup.

### 3.1 Database Schema

**Nowa tabela:** `group_invitations`

```sql
CREATE TABLE group_invitations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  group_id UUID REFERENCES groups(id) ON DELETE CASCADE NOT NULL,

  -- Invite methods
  invite_code VARCHAR(6) UNIQUE NOT NULL, -- e.g., "ABC123"
  invite_link TEXT UNIQUE NOT NULL,       -- e.g., "/join/abc123-def456..."

  -- Settings
  max_participants INTEGER,               -- NULL = unlimited
  expires_at TIMESTAMPTZ,                 -- NULL = never expires
  is_active BOOLEAN DEFAULT true,

  -- Stats
  uses_count INTEGER DEFAULT 0,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for fast lookups
CREATE INDEX idx_invitations_code ON group_invitations(invite_code);
CREATE INDEX idx_invitations_link ON group_invitations(invite_link);
```

**Modyfikacja `participants`:**
```sql
ALTER TABLE participants
ADD COLUMN joined_via VARCHAR(20), -- 'manual', 'invite_link', 'invite_code'
ADD COLUMN joined_at TIMESTAMPTZ DEFAULT NOW();
```

### 3.2 Invite Generation

**Lokalizacja:** `/src/lib/services/invitation.service.ts`

```typescript
import { nanoid } from 'nanoid';

export const invitationService = {
  async createInvitation(groupId: string, creatorId: string, options = {}) {
    const inviteCode = generateInviteCode(); // 6-char alphanumeric
    const inviteToken = nanoid(32);          // secure random token
    const inviteLink = `/join/${inviteToken}`;

    const { data, error } = await supabase
      .from('group_invitations')
      .insert({
        group_id: groupId,
        invite_code: inviteCode,
        invite_link: inviteLink,
        max_participants: options.maxParticipants || null,
        expires_at: options.expiresAt || null,
        created_by: creatorId,
      })
      .select()
      .single();

    return { data, error };
  },

  async getInvitation(codeOrToken: string) {
    // Try as code first (6 chars)
    if (codeOrToken.length === 6) {
      return supabase
        .from('group_invitations')
        .select('*, groups(*)')
        .eq('invite_code', codeOrToken.toUpperCase())
        .eq('is_active', true)
        .single();
    }

    // Otherwise treat as token
    return supabase
      .from('group_invitations')
      .select('*, groups(*)')
      .eq('invite_link', `/join/${codeOrToken}`)
      .eq('is_active', true)
      .single();
  },

  async validateInvitation(invitation) {
    // Check expiration
    if (invitation.expires_at && new Date(invitation.expires_at) < new Date()) {
      return { valid: false, reason: 'expired' };
    }

    // Check max participants
    if (invitation.max_participants) {
      const { count } = await supabase
        .from('participants')
        .select('*', { count: 'exact', head: true })
        .eq('group_id', invitation.group_id);

      if (count >= invitation.max_participants) {
        return { valid: false, reason: 'full' };
      }
    }

    // Check if draw already completed
    const { data: group } = await supabase
      .from('groups')
      .select('drawn_at')
      .eq('id', invitation.group_id)
      .single();

    if (group.drawn_at) {
      return { valid: false, reason: 'draw_completed' };
    }

    return { valid: true };
  },
};

function generateInviteCode(): string {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No confusing chars
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}
```

### 3.3 UI: Invite Management (dla organizatora)

**Komponent:** `/src/components/group/InviteSection.tsx`

```tsx
export function InviteSection({ group, invitation }) {
  const [copied, setCopied] = useState(false);
  const inviteUrl = `${window.location.origin}${invitation.invite_link}`;

  const copyToClipboard = () => {
    navigator.clipboard.writeText(inviteUrl);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Zaproszenia do grupy</CardTitle>
        <CardDescription>
          UdostÄ™pnij link lub kod, aby uczestnicy mogli doÅ‚Ä…czyÄ‡ samodzielnie
        </CardDescription>
      </CardHeader>

      <CardContent className="space-y-4">
        {/* Invite Link */}
        <div>
          <Label>Link zaproszeniowy</Label>
          <div className="flex gap-2 mt-2">
            <Input value={inviteUrl} readOnly />
            <Button onClick={copyToClipboard} variant="outline">
              {copied ? <Check className="h-4 w-4" /> : <Copy className="h-4 w-4" />}
            </Button>
          </div>
        </div>

        {/* Invite Code */}
        <div>
          <Label>Kod zaproszeniowy</Label>
          <div className="text-3xl font-mono font-bold tracking-wider mt-2">
            {invitation.invite_code}
          </div>
          <p className="text-sm text-muted-foreground mt-1">
            Uczestnicy mogÄ… wpisaÄ‡ ten kod na stronie gÅ‚Ã³wnej
          </p>
        </div>

        {/* Settings */}
        <Separator />

        <div className="grid grid-cols-2 gap-4">
          <div>
            <Label>Limit uczestnikÃ³w</Label>
            <Input
              type="number"
              value={invitation.max_participants || ''}
              placeholder="Bez limitu"
              onChange={(e) => updateInvitation({ max_participants: e.target.value })}
            />
          </div>

          <div>
            <Label>Wygasa</Label>
            <Input
              type="date"
              value={invitation.expires_at || ''}
              onChange={(e) => updateInvitation({ expires_at: e.target.value })}
            />
          </div>
        </div>

        {/* Stats */}
        <div className="bg-muted p-4 rounded-lg">
          <div className="text-sm text-muted-foreground">
            DoÅ‚Ä…czono przez zaproszenie
          </div>
          <div className="text-2xl font-bold">
            {invitation.uses_count} osÃ³b
          </div>
        </div>

        {/* Actions */}
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={() => regenerateInviteCode()}
          >
            Regeneruj kod
          </Button>

          <Button
            variant="destructive"
            onClick={() => deactivateInvitation()}
          >
            Dezaktywuj zaproszenia
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```

### 3.4 UI: Join Page (dla doÅ‚Ä…czajÄ…cych)

**Strona:** `/src/pages/join/[token].astro`

```astro
---
import { invitationService } from '@/lib/services/invitation.service';

const { token } = Astro.params;
const { data: invitation, error } = await invitationService.getInvitation(token);

if (error || !invitation) {
  return Astro.redirect('/404');
}

const validation = await invitationService.validateInvitation(invitation);

if (!validation.valid) {
  // Show error page with reason
}
---

<Layout title={`DoÅ‚Ä…cz do ${invitation.groups.name}`}>
  <JoinGroupForm invitation={invitation} />
</Layout>
```

**Komponent:** `/src/components/forms/JoinGroupForm.tsx`

```tsx
export function JoinGroupForm({ invitation }) {
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    wishlist: '',
  });

  const handleSubmit = async (e) => {
    e.preventDefault();

    // Create participant
    const { data, error } = await supabase
      .from('participants')
      .insert({
        group_id: invitation.group_id,
        name: formData.name,
        email: formData.email || null,
        joined_via: 'invite_link',
        access_token: nanoid(32),
      })
      .select()
      .single();

    if (error) {
      toast.error('BÅ‚Ä…d doÅ‚Ä…czania do grupy');
      return;
    }

    // Create wishlist if provided
    if (formData.wishlist) {
      await supabase.from('wishes').insert({
        participant_id: data.id,
        content: formData.wishlist,
      });
    }

    // Increment invitation uses
    await supabase.rpc('increment_invitation_uses', {
      invitation_id: invitation.id,
    });

    // Redirect to success page
    router.push(`/join/success?token=${data.access_token}`);
  };

  return (
    <Card className="max-w-lg mx-auto">
      <CardHeader>
        <CardTitle className="text-center">
          ğŸ DoÅ‚Ä…cz do Secret Santa
        </CardTitle>
        <CardDescription className="text-center">
          {invitation.groups.name}
        </CardDescription>
      </CardHeader>

      <CardContent>
        {/* Group Info */}
        <div className="bg-muted p-4 rounded-lg mb-6 space-y-2">
          <div className="flex justify-between">
            <span className="text-sm text-muted-foreground">BudÅ¼et</span>
            <span className="font-medium">{invitation.groups.budget} PLN</span>
          </div>
          <div className="flex justify-between">
            <span className="text-sm text-muted-foreground">Data wydarzenia</span>
            <span className="font-medium">
              {format(new Date(invitation.groups.end_date), 'dd.MM.yyyy')}
            </span>
          </div>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label htmlFor="name">Twoje imiÄ™ *</Label>
            <Input
              id="name"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              required
              placeholder="Jan Kowalski"
            />
          </div>

          <div>
            <Label htmlFor="email">Email (opcjonalnie)</Label>
            <Input
              id="email"
              type="email"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              placeholder="jan@example.com"
            />
            <p className="text-xs text-muted-foreground mt-1">
              Otrzymasz powiadomienie kiedy losowanie bÄ™dzie gotowe
            </p>
          </div>

          <div>
            <Label htmlFor="wishlist">Twoja lista Å¼yczeÅ„ (opcjonalnie)</Label>
            <Textarea
              id="wishlist"
              value={formData.wishlist}
              onChange={(e) => setFormData({ ...formData, wishlist: e.target.value })}
              placeholder="MoÅ¼esz wkleiÄ‡ linki lub opisaÄ‡ co chciaÅ‚byÅ› dostaÄ‡..."
              rows={4}
            />
          </div>

          <Button type="submit" className="w-full">
            DoÅ‚Ä…cz do grupy
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}
```

### 3.5 Join via Code (alternatywna Å›cieÅ¼ka)

**Strona:** `/src/pages/join/index.astro`

```tsx
<Layout title="DoÅ‚Ä…cz przez kod">
  <Card className="max-w-md mx-auto">
    <CardHeader>
      <CardTitle>Masz kod zaproszeniowy?</CardTitle>
    </CardHeader>
    <CardContent>
      <form onSubmit={handleCodeSubmit}>
        <Label>Wpisz 6-znakowy kod</Label>
        <Input
          maxLength={6}
          placeholder="ABC123"
          className="text-center text-2xl font-mono tracking-wider uppercase"
          onChange={(e) => setCode(e.target.value.toUpperCase())}
        />
        <Button type="submit" className="w-full mt-4">
          Kontynuuj
        </Button>
      </form>
    </CardContent>
  </Card>
</Layout>
```

### 3.6 Security Considerations

**Rate limiting:**
```typescript
// Prevent brute-force code guessing
const RATE_LIMIT = {
  maxAttempts: 5,
  windowMs: 15 * 60 * 1000, // 15 minutes
};

// Implement with Redis or in-memory store
```

**Token validation:**
- Invite tokens: 32 characters (nanoid) = 193 bits entropy
- Invite codes: 6 characters from 34-char alphabet = ~30 bits entropy
- Codes can be brute-forced â†’ rate limiting required

**Auto-deactivation:**
```sql
-- Cron job: deactivate expired invitations
UPDATE group_invitations
SET is_active = false
WHERE expires_at < NOW() AND is_active = true;
```

### 3.7 Email Integration

**Komponent:** `/src/emails/templates/InvitationEmail.tsx`

```tsx
export function InvitationEmail({ invitation, group, inviter }) {
  return (
    <Email>
      <Heading>ğŸ Zaproszenie do Secret Santa</Heading>
      <Text>
        {inviter.name} zaprasza CiÄ™ do grupy "{group.name}"!
      </Text>

      <Section>
        <Text>ğŸ’° BudÅ¼et: {group.budget} PLN</Text>
        <Text>ğŸ“… Data: {format(group.end_date, 'dd.MM.yyyy')}</Text>
      </Section>

      <Button href={invitationLink}>DoÅ‚Ä…cz do grupy</Button>

      <Text>Lub uÅ¼yj kodu: <strong>{invitation.invite_code}</strong></Text>
    </Email>
  );
}
```

**Use case:**
Organizator moÅ¼e "Invite by Email" - wpisuje adres, system wysyÅ‚a email z linkiem.

### 3.8 Analytics

**Metryki:**
- Conversion rate: (joined / clicked link) %
- Most popular join method: link vs code
- Average time from invite sent to joined
- Abandoned invitations (clicked but not joined)

**Dashboard dla organizatora:**
```tsx
<InviteAnalytics>
  <Stat label="Link otwarty" value="23 razy" />
  <Stat label="DoÅ‚Ä…czyÅ‚o" value="18 osÃ³b" />
  <Stat label="Conversion rate" value="78%" />
</InviteAnalytics>
```

### Deliverables FAZA 3
- âœ… Database schema dla invitations
- âœ… Invite link & code generation
- âœ… Join page (public, no auth required)
- âœ… Invite management UI (organizer)
- âœ… Email invitation option
- âœ… Rate limiting & security
- âœ… Analytics dashboard
- âœ… Tests (unit + E2E)

### Success Criteria
- Uczestnicy mogÄ… doÅ‚Ä…czyÄ‡ samodzielnie
- Conversion rate >60% (clicked â†’ joined)
- Zero security incidents (brute force, etc.)
- Organizatorzy uÅ¼ywajÄ… invites w >80% grup

---

## â™»ï¸ FAZA 4: Edycja i Re-losowanie
**Timeline:** TydzieÅ„ 11-14
**Priorytet:** ğŸŸ¡ ÅšREDNI

### Cele
ElastycznoÅ›Ä‡ w przypadku bÅ‚Ä™dÃ³w, zmian planÃ³w, lub niezadowolenia z losowania. MoÅ¼liwoÅ›Ä‡ wielokrotnego losowania przed finalizacjÄ….

### 4.1 Draw States (State Machine)

**Obecny stan:** Binary (drawn_at: null | timestamp)

**Nowy model:** Explicit states

```sql
-- Modify groups table
ALTER TABLE groups
ADD COLUMN draw_status VARCHAR(20) DEFAULT 'pending'
  CHECK (draw_status IN ('pending', 'draft', 'finalized')),
ADD COLUMN finalized_at TIMESTAMPTZ;

-- Migration data
UPDATE groups
SET draw_status = CASE
  WHEN drawn_at IS NULL THEN 'pending'
  ELSE 'finalized'
END;
```

**States:**
1. **`pending`** - nie byÅ‚o jeszcze losowania
2. **`draft`** - losowanie wykonane, ale moÅ¼na cofnÄ…Ä‡ i powtÃ³rzyÄ‡
3. **`finalized`** - losowanie zatwierdzone, nieodwracalne

**State transitions:**
```
pending â†’ draft        (Execute Draw)
draft â†’ pending        (Discard Draw)
draft â†’ draft          (Re-draw)
draft â†’ finalized      (Finalize Draw)
finalized â†’ [blocked]  (no way back)
```

### 4.2 Draft Mode Features

**Komponent:** `/src/components/group/DrawStatusBanner.tsx`

```tsx
export function DrawStatusBanner({ group }) {
  if (group.draw_status === 'draft') {
    return (
      <Alert variant="warning">
        <AlertCircle className="h-4 w-4" />
        <AlertTitle>Losowanie w trybie roboczym</AlertTitle>
        <AlertDescription>
          Wyniki sÄ… tymczasowe. MoÅ¼esz je cofnÄ…Ä‡ i losowaÄ‡ ponownie.
          <div className="flex gap-2 mt-3">
            <Button onClick={handleFinalize} variant="default">
              âœ“ ZatwierdÅº losowanie
            </Button>
            <Button onClick={handleDiscard} variant="outline">
              âœ• OdrzuÄ‡ i losuj ponownie
            </Button>
          </div>
        </AlertDescription>
      </Alert>
    );
  }

  if (group.draw_status === 'finalized') {
    return (
      <Alert variant="success">
        <Check className="h-4 w-4" />
        <AlertTitle>Losowanie zatwierdzone</AlertTitle>
        <AlertDescription>
          Wyniki sÄ… finalne i nie moÅ¼na ich zmieniÄ‡.
          Finalizacja: {format(group.finalized_at, 'dd.MM.yyyy HH:mm')}
        </AlertDescription>
      </Alert>
    );
  }

  return null;
}
```

### 4.3 Re-Draw Logic

**Service:** `/src/lib/services/draw.service.ts`

```typescript
export const drawService = {
  // Existing: performDraw()

  async redraw(groupId: string, userId: string) {
    // 1. Verify group is in draft state
    const { data: group } = await supabase
      .from('groups')
      .select('draw_status, creator_id')
      .eq('id', groupId)
      .single();

    if (group.draw_status !== 'draft') {
      throw new Error('Can only re-draw in draft state');
    }

    if (group.creator_id !== userId) {
      throw new Error('Only creator can re-draw');
    }

    // 2. Delete existing assignments
    await supabase
      .from('assignments')
      .delete()
      .eq('group_id', groupId);

    // 3. Perform new draw
    const newAssignments = await this.performDraw(groupId);

    // 4. Log the re-draw
    await supabase.from('draw_history').insert({
      group_id: groupId,
      performed_by: userId,
      action: 'redraw',
      performed_at: new Date(),
    });

    return newAssignments;
  },

  async finalizeDraw(groupId: string, userId: string) {
    // 1. Verify draft state
    const { data: group } = await supabase
      .from('groups')
      .select('draw_status, creator_id')
      .eq('id', groupId)
      .single();

    if (group.draw_status !== 'draft') {
      throw new Error('Can only finalize draft draws');
    }

    if (group.creator_id !== userId) {
      throw new Error('Only creator can finalize');
    }

    // 2. Check if any participant viewed results
    const { data: viewedParticipants } = await supabase
      .from('participants')
      .select('id, name, result_viewed_at')
      .eq('group_id', groupId)
      .not('result_viewed_at', 'is', null);

    if (viewedParticipants.length > 0) {
      // Warning: some people already saw results
      return {
        requiresConfirmation: true,
        viewedCount: viewedParticipants.length,
        viewedParticipants,
      };
    }

    // 3. Finalize
    await supabase
      .from('groups')
      .update({
        draw_status: 'finalized',
        finalized_at: new Date(),
      })
      .eq('id', groupId);

    // 4. Send notifications (if not sent yet)
    await emailService.sendDrawCompletedEmails(groupId);

    // 5. Log
    await supabase.from('draw_history').insert({
      group_id: groupId,
      performed_by: userId,
      action: 'finalize',
      performed_at: new Date(),
    });

    return { success: true };
  },

  async discardDraw(groupId: string, userId: string) {
    // Similar to redraw, but sets status back to 'pending'
    await supabase
      .from('groups')
      .update({ draw_status: 'pending', drawn_at: null })
      .eq('id', groupId);

    await supabase
      .from('assignments')
      .delete()
      .eq('group_id', groupId);

    await supabase.from('draw_history').insert({
      group_id: groupId,
      performed_by: userId,
      action: 'discard',
      performed_at: new Date(),
    });
  },
};
```

### 4.4 Draw History (Audit Log)

**Tabela:** `draw_history`

```sql
CREATE TABLE draw_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  group_id UUID REFERENCES groups(id) ON DELETE CASCADE,
  performed_by UUID REFERENCES auth.users(id),
  action VARCHAR(20) CHECK (action IN ('draw', 'redraw', 'discard', 'finalize')),
  assignments_snapshot JSONB, -- Copy of assignments at this point
  performed_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_draw_history_group ON draw_history(group_id, performed_at DESC);
```

**Use case:**
Organizator moÅ¼e zobaczyÄ‡ "Kim byÅ‚em w poprzednim losowaniu?" po re-draw.

**UI:** `/src/components/group/DrawHistory.tsx`

```tsx
<Accordion type="single" collapsible>
  <AccordionItem value="history">
    <AccordionTrigger>Historia losowaÅ„ (3)</AccordionTrigger>
    <AccordionContent>
      {history.map((entry) => (
        <div key={entry.id} className="border-l-2 pl-4 mb-4">
          <div className="text-sm font-medium">
            {entry.action === 'draw' && 'ğŸ² Pierwsze losowanie'}
            {entry.action === 'redraw' && 'ğŸ”„ Ponowne losowanie'}
            {entry.action === 'discard' && 'âŒ Odrzucono'}
            {entry.action === 'finalize' && 'âœ“ Zatwierdzono'}
          </div>
          <div className="text-xs text-muted-foreground">
            {format(entry.performed_at, 'dd.MM.yyyy HH:mm')}
          </div>

          {entry.action === 'redraw' && entry.assignments_snapshot && (
            <Button
              variant="ghost"
              size="sm"
              onClick={() => showPreviousAssignments(entry)}
            >
              Zobacz poprzednie pary
            </Button>
          )}
        </div>
      ))}
    </AccordionContent>
  </AccordionItem>
</Accordion>
```

### 4.5 Finalization Confirmation Modal

**Komponent:** `/src/components/group/FinalizeDrawModal.tsx`

```tsx
export function FinalizeDrawModal({ group, viewedParticipants, onConfirm }) {
  return (
    <AlertDialog>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Czy na pewno chcesz zatwierdziÄ‡?</AlertDialogTitle>
          <AlertDialogDescription>
            {viewedParticipants.length > 0 ? (
              <>
                <Alert variant="warning" className="mb-4">
                  <AlertCircle className="h-4 w-4" />
                  <AlertTitle>Uwaga!</AlertTitle>
                  <AlertDescription>
                    {viewedParticipants.length} osÃ³b juÅ¼ otworzyÅ‚o swoje wyniki.
                    JeÅ›li teraz odrzucisz losowanie, ich wyniki siÄ™ zmieniÄ….
                  </AlertDescription>
                </Alert>

                <div className="text-sm">
                  <p className="font-medium mb-2">Osoby ktÃ³re widziaÅ‚y wyniki:</p>
                  <ul className="list-disc pl-5 space-y-1">
                    {viewedParticipants.map((p) => (
                      <li key={p.id}>
                        {p.name} - {format(p.result_viewed_at, 'dd.MM HH:mm')}
                      </li>
                    ))}
                  </ul>
                </div>
              </>
            ) : (
              <p>
                Nikt jeszcze nie otworzyÅ‚ wynikÃ³w. MoÅ¼esz bezpiecznie zatwierdziÄ‡ losowanie.
              </p>
            )}

            <p className="mt-4 font-medium">
              Po zatwierdzeniu nie bÄ™dzie moÅ¼liwoÅ›ci zmiany wynikÃ³w ani ponownego losowania.
            </p>
          </AlertDialogDescription>
        </AlertDialogHeader>

        <AlertDialogFooter>
          <AlertDialogCancel>Anuluj</AlertDialogCancel>
          <AlertDialogAction onClick={onConfirm}>
            ZatwierdÅº losowanie
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

### 4.6 Participant View (Draft State)

**Efekt dla uczestnikÃ³w:**

W trybie `draft`:
- WidzÄ… wynik normalnie
- DostajÄ… watermark "WERSJA ROBOCZA"
- Banner: "To losowanie jeszcze nie jest finalne. Organizator moÅ¼e je zmieniÄ‡."

W trybie `finalized`:
- Normalny widok
- Brak ostrzeÅ¼eÅ„

**Komponent:** `/src/components/result/DraftWarning.tsx`

```tsx
{group.draw_status === 'draft' && (
  <Alert variant="info" className="mb-6">
    <Info className="h-4 w-4" />
    <AlertTitle>Wersja robocza</AlertTitle>
    <AlertDescription>
      To losowanie jeszcze nie zostaÅ‚o zatwierdzone przez organizatora.
      TwÃ³j wynik moÅ¼e siÄ™ zmieniÄ‡.
    </AlertDescription>
  </Alert>
)}
```

### 4.7 API Endpoints

**Routes:**

```typescript
// POST /api/groups/:id/draw/redraw
export async function POST({ params, locals }) {
  const user = locals.user;
  const { id: groupId } = params;

  try {
    const result = await drawService.redraw(groupId, user.id);
    return new Response(JSON.stringify(result), { status: 200 });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 400,
    });
  }
}

// POST /api/groups/:id/draw/finalize
export async function POST({ params, locals }) {
  const user = locals.user;
  const { id: groupId } = params;

  const result = await drawService.finalizeDraw(groupId, user.id);

  if (result.requiresConfirmation) {
    // Return warning, need explicit confirmation
    return new Response(
      JSON.stringify({
        requiresConfirmation: true,
        viewedCount: result.viewedCount,
        viewedParticipants: result.viewedParticipants,
      }),
      { status: 200 }
    );
  }

  return new Response(JSON.stringify({ success: true }), { status: 200 });
}

// POST /api/groups/:id/draw/discard
export async function POST({ params, locals }) {
  // Similar implementation
}

// GET /api/groups/:id/draw/history
export async function GET({ params }) {
  const { data } = await supabase
    .from('draw_history')
    .select('*')
    .eq('group_id', params.id)
    .order('performed_at', { ascending: false });

  return new Response(JSON.stringify(data), { status: 200 });
}
```

### 4.8 Auto-Finalize (Optional)

**Use case:** Auto-finalize po X dniach lub kiedy wszyscy zobaczyli wyniki

```sql
-- Cron job: auto-finalize drafts after 7 days if all participants viewed
CREATE OR REPLACE FUNCTION auto_finalize_old_drafts()
RETURNS void AS $$
BEGIN
  UPDATE groups g
  SET draw_status = 'finalized', finalized_at = NOW()
  WHERE g.draw_status = 'draft'
    AND g.drawn_at < NOW() - INTERVAL '7 days'
    AND NOT EXISTS (
      SELECT 1 FROM participants p
      WHERE p.group_id = g.id
        AND p.result_viewed_at IS NULL
    );
END;
$$ LANGUAGE plpgsql;

-- Schedule daily
SELECT cron.schedule('auto-finalize-drafts', '0 2 * * *', 'SELECT auto_finalize_old_drafts()');
```

### Deliverables FAZA 4
- âœ… Draw states (pending/draft/finalized)
- âœ… Re-draw functionality
- âœ… Finalize with confirmation
- âœ… Draft mode UI for participants
- âœ… Draw history audit log
- âœ… Warning system (viewed participants)
- âœ… Auto-finalize (optional)
- âœ… Tests

### Success Criteria
- Organizatorzy mogÄ… bezpiecznie re-draw
- Zero przypadkÃ³w lost data
- Uczestnicy rozumiejÄ… draft vs finalized
- <5% grup uÅ¼ywa re-draw (jeÅ›li wiÄ™cej = problem z algorytmem)

---

## ğŸ¨ FAZA 5: UX Enhancements
**Timeline:** TydzieÅ„ 15-18
**Priorytet:** ğŸŸ¡ ÅšREDNI

### Cele
Poprawa doÅ›wiadczenia uÅ¼ytkownika, zwiÄ™kszenie engagement, uÅ‚atwienie dopasowania prezentÃ³w.

### 5.1 Onboarding & Guided Tour

**Biblioteka:** Shepherd.js lub Intro.js

**Setup:**
```bash
npm install shepherd.js
```

**Implementacja:** `/src/lib/tour.ts`

```typescript
import Shepherd from 'shepherd.js';
import 'shepherd.js/dist/css/shepherd.css';

export function startOnboardingTour() {
  const tour = new Shepherd.Tour({
    useModalOverlay: true,
    defaultStepOptions: {
      cancelIcon: { enabled: true },
      classes: 'shepherd-theme-custom',
      scrollTo: { behavior: 'smooth', block: 'center' },
    },
  });

  tour.addStep({
    id: 'welcome',
    text: 'ğŸ‘‹ Witaj w Secret Santa! PokaÅ¼Ä™ Ci jak stworzyÄ‡ swojÄ… pierwszÄ… grupÄ™.',
    buttons: [
      { text: 'PomiÅ„', action: tour.cancel },
      { text: 'Zaczynajmy!', action: tour.next },
    ],
  });

  tour.addStep({
    id: 'create-group',
    text: 'Kliknij tutaj aby stworzyÄ‡ nowÄ… grupÄ™ prezentowÄ….',
    attachTo: { element: '#create-group-btn', on: 'bottom' },
    buttons: [
      { text: 'Wstecz', action: tour.back },
      { text: 'Dalej', action: tour.next },
    ],
  });

  // ... wiÄ™cej krokÃ³w

  tour.start();
}

// Trigger on first login
if (!localStorage.getItem('onboarding_completed')) {
  startOnboardingTour();
  localStorage.setItem('onboarding_completed', 'true');
}
```

**Kroki tour:**
1. Welcome message
2. "UtwÃ³rz grupÄ™" button
3. Formularz grupy (nazwa, budÅ¼et, data)
4. Dodawanie uczestnikÃ³w
5. ReguÅ‚y wykluczeÅ„ (opcjonalne)
6. Losowanie
7. Wyniki

**Trigger points:**
- Pierwszy login uÅ¼ytkownika
- Pierwszy raz w view grupy
- Po pierwszym draw (how to check results)

### 5.2 Sample/Template Groups

**Use case:** Nowi uÅ¼ytkownicy mogÄ… przetestowaÄ‡ funkcje bez dodawania prawdziwych osÃ³b.

**Implementacja:**

```typescript
async function createSampleGroup(userId: string) {
  // Create demo group
  const { data: group } = await supabase.from('groups').insert({
    name: 'ğŸ„ PrzykÅ‚adowa Grupa (Demo)',
    budget: 100,
    end_date: addDays(new Date(), 30),
    creator_id: userId,
    is_sample: true, // New flag
  }).select().single();

  // Add sample participants
  const participants = [
    { name: 'Anna Kowalska' },
    { name: 'Jan Nowak' },
    { name: 'Maria WiÅ›niewska' },
    { name: 'Piotr ZieliÅ„ski' },
  ];

  for (const p of participants) {
    await supabase.from('participants').insert({
      group_id: group.id,
      name: p.name,
      access_token: nanoid(32),
    });
  }

  // Add sample exclusion
  const [anna, jan] = await getParticipants(group.id);
  await supabase.from('exclusion_rules').insert({
    group_id: group.id,
    participant_a_id: anna.id,
    participant_b_id: jan.id,
  });

  return group;
}
```

**UI:**
```tsx
<Card className="border-dashed border-2 border-primary">
  <CardHeader>
    <CardTitle>ğŸ“ WyprÃ³buj funkcje</CardTitle>
    <CardDescription>
      StwÃ³rz przykÅ‚adowÄ… grupÄ™ aby zobaczyÄ‡ jak dziaÅ‚a Secret Santa
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Button onClick={createSample}>UtwÃ³rz grupÄ™ demo</Button>
  </CardContent>
</Card>
```

**Watermark dla sample groups:**
- Badge "DEMO" przy nazwie
- Banner: "To jest przykÅ‚adowa grupa. MoÅ¼esz jÄ… usunÄ…Ä‡ kiedy bÄ™dziesz gotowy."
- Opcja "Delete all sample groups"

### 5.3 Enhanced Wishlist Editor

#### Rich Text Formatting

**Biblioteka:** Tiptap (lightweight WYSIWYG)

```bash
npm install @tiptap/react @tiptap/starter-kit
```

**Komponent:** `/src/components/result/RichWishlistEditor.tsx`

```tsx
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Link from '@tiptap/extension-link';

export function RichWishlistEditor({ initialContent, onSave }) {
  const editor = useEditor({
    extensions: [
      StarterKit,
      Link.configure({
        openOnClick: false,
        autolink: true,
      }),
    ],
    content: initialContent,
    onUpdate: ({ editor }) => {
      const html = editor.getHTML();
      debouncedSave(html);
    },
  });

  return (
    <div className="border rounded-lg">
      {/* Toolbar */}
      <div className="flex gap-1 p-2 border-b bg-muted">
        <Button
          size="sm"
          variant="ghost"
          onClick={() => editor.chain().focus().toggleBold().run()}
          className={editor.isActive('bold') ? 'bg-accent' : ''}
        >
          <Bold className="h-4 w-4" />
        </Button>

        <Button
          size="sm"
          variant="ghost"
          onClick={() => editor.chain().focus().toggleItalic().run()}
          className={editor.isActive('italic') ? 'bg-accent' : ''}
        >
          <Italic className="h-4 w-4" />
        </Button>

        <Button
          size="sm"
          variant="ghost"
          onClick={() => editor.chain().focus().toggleBulletList().run()}
          className={editor.isActive('bulletList') ? 'bg-accent' : ''}
        >
          <List className="h-4 w-4" />
        </Button>

        <Separator orientation="vertical" className="mx-1" />

        <Button
          size="sm"
          variant="ghost"
          onClick={addLink}
        >
          <Link2 className="h-4 w-4" />
        </Button>
      </div>

      {/* Editor */}
      <EditorContent editor={editor} className="p-4 min-h-[200px]" />
    </div>
  );
}
```

**Features:**
- âœ… Bold, italic, underline
- âœ… Bullet lists, numbered lists
- âœ… Links (auto-detect + manual add)
- âœ… No images (keep it simple)
- âœ… Auto-save (2s debounce)

#### Drag & Drop Prioritization

**Biblioteka:** @dnd-kit/core

```tsx
import { DndContext, closestCenter } from '@dnd-kit/core';
import { arrayMove, SortableContext, useSortable } from '@dnd-kit/sortable';

export function PrioritizedWishlist({ items, setItems }) {
  const handleDragEnd = (event) => {
    const { active, over } = event;
    if (active.id !== over.id) {
      const oldIndex = items.findIndex((i) => i.id === active.id);
      const newIndex = items.findIndex((i) => i.id === over.id);
      setItems(arrayMove(items, oldIndex, newIndex));
    }
  };

  return (
    <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
      <SortableContext items={items}>
        {items.map((item, index) => (
          <SortableWishItem key={item.id} item={item} index={index} />
        ))}
      </SortableContext>
    </DndContext>
  );
}

function SortableWishItem({ item, index }) {
  const { attributes, listeners, setNodeRef, transform, transition } = useSortable({
    id: item.id,
  });

  return (
    <div
      ref={setNodeRef}
      style={{ transform: CSS.Transform.toString(transform), transition }}
      {...attributes}
      {...listeners}
      className="flex items-center gap-3 p-3 border rounded-lg mb-2 bg-card cursor-move hover:bg-accent"
    >
      <GripVertical className="h-5 w-5 text-muted-foreground" />
      <div className="flex-1">
        <div className="font-medium">{item.name}</div>
        {item.price && (
          <div className="text-sm text-muted-foreground">~{item.price} PLN</div>
        )}
      </div>
      <Badge variant="outline">#{index + 1}</Badge>
    </div>
  );
}
```

**UX:**
- Numbered priority (1 = most wanted)
- Visual indicator podczas draggania
- Touch support dla mobile
- Auto-save po kaÅ¼dej zmianie kolejnoÅ›ci

#### Price Ranges

**Struktura danych:**

```typescript
interface WishlistItem {
  id: string;
  name: string;
  description?: string;
  url?: string;
  price_min?: number;
  price_max?: number;
  priority: number; // 1-based index
}
```

**Tabela:** `wishlist_items`

```sql
CREATE TABLE wishlist_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  participant_id UUID REFERENCES participants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  url TEXT,
  price_min INTEGER,
  price_max INTEGER,
  priority INTEGER NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Migracja z `wishes`:**
- ZachowaÄ‡ `wishes.content` jako fallback dla plain text
- Nowy field `wishes.structured_items` (JSONB array)
- Dual mode: plain text vs structured items

**Add Item Form:**

```tsx
<Dialog>
  <DialogTrigger asChild>
    <Button>+ Dodaj przedmiot</Button>
  </DialogTrigger>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Dodaj przedmiot do listy</DialogTitle>
    </DialogHeader>

    <form onSubmit={handleAddItem} className="space-y-4">
      <div>
        <Label>Nazwa przedmiotu *</Label>
        <Input placeholder="np. KsiÄ…Å¼ka o TypeScript" required />
      </div>

      <div>
        <Label>Opis (opcjonalnie)</Label>
        <Textarea placeholder="Dodatkowe szczegÃ³Å‚y..." />
      </div>

      <div>
        <Label>Link (opcjonalnie)</Label>
        <Input type="url" placeholder="https://..." />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <Label>Cena od (PLN)</Label>
          <Input type="number" placeholder="50" />
        </div>
        <div>
          <Label>Cena do (PLN)</Label>
          <Input type="number" placeholder="150" />
        </div>
      </div>

      <DialogFooter>
        <Button type="submit">Dodaj</Button>
      </DialogFooter>
    </form>
  </DialogContent>
</Dialog>
```

**Display:**
```tsx
<div className="space-y-2">
  {items.map((item) => (
    <Card key={item.id}>
      <CardContent className="p-4">
        <div className="flex justify-between items-start">
          <div>
            <h4 className="font-medium">{item.name}</h4>
            {item.description && (
              <p className="text-sm text-muted-foreground mt-1">
                {item.description}
              </p>
            )}
            {item.url && (
              <a href={item.url} className="text-sm text-primary hover:underline mt-1 block">
                Zobacz produkt â†’
              </a>
            )}
          </div>

          {(item.price_min || item.price_max) && (
            <Badge variant="secondary">
              {item.price_min && item.price_max
                ? `${item.price_min}-${item.price_max} PLN`
                : item.price_min
                ? `od ${item.price_min} PLN`
                : `do ${item.price_max} PLN`}
            </Badge>
          )}
        </div>
      </CardContent>
    </Card>
  ))}
</div>
```

#### Gift Inspirations

**Use case:** Pomoc w znalezieniu prezentu w danym budÅ¼ecie

**API Integration:** Allegro API lub scraping popularnych sklepÃ³w

```typescript
async function fetchGiftInspirations(budget: number, category?: string) {
  // Call Allegro API
  const response = await fetch(
    `https://api.allegro.pl/offers/listing?price.to=${budget}&category=${category}`,
    {
      headers: {
        Authorization: `Bearer ${ALLEGRO_TOKEN}`,
      },
    }
  );

  const data = await response.json();

  return data.items.map((item) => ({
    name: item.name,
    price: item.sellingMode.price.amount,
    url: item.url,
    image: item.images[0]?.url,
  }));
}
```

**UI:** `/src/components/result/GiftInspirations.tsx`

```tsx
<Accordion type="single" collapsible>
  <AccordionItem value="inspirations">
    <AccordionTrigger>
      ğŸ’¡ Szukasz inspiracji? ({budget} PLN)
    </AccordionTrigger>
    <AccordionContent>
      <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
        {inspirations.map((gift) => (
          <Card key={gift.id} className="overflow-hidden">
            {gift.image && (
              <img src={gift.image} alt={gift.name} className="w-full h-32 object-cover" />
            )}
            <CardContent className="p-3">
              <h4 className="text-sm font-medium line-clamp-2">{gift.name}</h4>
              <div className="flex justify-between items-center mt-2">
                <span className="text-sm font-bold">{gift.price} PLN</span>
                <Button size="sm" variant="ghost" asChild>
                  <a href={gift.url} target="_blank">
                    <ExternalLink className="h-3 w-3" />
                  </a>
                </Button>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </AccordionContent>
  </AccordionItem>
</Accordion>
```

**Filters:**
- Category (electronics, books, home, fashion, etc.)
- Price range (within budget)
- Popularity/rating

### 5.4 Social Features (Light)

#### Emoji Reactions na Wishlist Items

**Tabela:** `wishlist_reactions`

```sql
CREATE TABLE wishlist_reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  wishlist_item_id UUID REFERENCES wishlist_items(id) ON DELETE CASCADE,
  participant_id UUID REFERENCES participants(id) ON DELETE CASCADE,
  reaction VARCHAR(10) CHECK (reaction IN ('ğŸ‘', 'â¤ï¸', 'ğŸ˜', 'ğŸ”¥', 'ğŸ‘')),
  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(wishlist_item_id, participant_id) -- One reaction per person
);
```

**UI:**

```tsx
<div className="flex gap-1 mt-2">
  {['ğŸ‘', 'â¤ï¸', 'ğŸ˜', 'ğŸ”¥', 'ğŸ‘'].map((emoji) => (
    <Button
      key={emoji}
      size="sm"
      variant="ghost"
      className="h-7 px-2"
      onClick={() => toggleReaction(emoji)}
    >
      {emoji}
      {getReactionCount(emoji) > 0 && (
        <span className="ml-1 text-xs">{getReactionCount(emoji)}</span>
      )}
    </Button>
  ))}
</div>
```

**Use case:**
- Giver moÅ¼e zareagowaÄ‡ na items (np. â¤ï¸ na czymÅ› co kupi)
- Nie wyÅ›wietla KTO zareagowaÅ‚ (anonimowoÅ›Ä‡)
- Receiver widzi "KtoÅ› polubiÅ‚ ten przedmiot!" â†’ hint

#### Private Notes (tylko dla organizatora)

**Tabela:** `participant_notes`

```sql
CREATE TABLE participant_notes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  participant_id UUID REFERENCES participants(id) ON DELETE CASCADE,
  group_id UUID REFERENCES groups(id) ON DELETE CASCADE,
  creator_id UUID REFERENCES auth.users(id),
  note TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(participant_id, creator_id)
);
```

**Use case:**
Organizator moÅ¼e notowaÄ‡ informacje o uczestnikach (np. "Alergik na orzeszki", "Lubi fantasy")

**UI:**

```tsx
// W widoku organizatora przy liÅ›cie uczestnikÃ³w
<Card>
  <CardHeader>
    <CardTitle>{participant.name}</CardTitle>
  </CardHeader>
  <CardContent>
    <Textarea
      placeholder="Prywatne notatki (widoczne tylko dla Ciebie)..."
      value={notes[participant.id] || ''}
      onChange={(e) => updateNote(participant.id, e.target.value)}
      className="text-sm"
    />
  </CardContent>
</Card>
```

#### Anonymous Hints

**Use case:**
Giver moÅ¼e wysÅ‚aÄ‡ anonimowÄ… podpowiedÅº do receiver

**Tabela:** `anonymous_hints`

```sql
CREATE TABLE anonymous_hints (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  assignment_id UUID REFERENCES assignments(id) ON DELETE CASCADE,
  hint TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**UI (Giver side):**

```tsx
<Card className="mt-6">
  <CardHeader>
    <CardTitle>ğŸ’¬ WyÅ›lij anonimowÄ… podpowiedÅº</CardTitle>
    <CardDescription>
      MoÅ¼esz zadaÄ‡ pytanie lub poprosiÄ‡ o wiÄ™cej szczegÃ³Å‚Ã³w - anonimowo!
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Textarea
      placeholder="np. 'Preferujesz ksiÄ…Å¼ki papierowe czy e-booki?'"
      value={hint}
      onChange={(e) => setHint(e.target.value)}
    />
    <Button onClick={sendHint} className="mt-2">WyÅ›lij</Button>
  </CardContent>
</Card>
```

**UI (Receiver side):**

```tsx
{hints.length > 0 && (
  <Alert>
    <MessageCircle className="h-4 w-4" />
    <AlertTitle>Twoja Tajemnicza Osoba wysÅ‚aÅ‚a wiadomoÅ›Ä‡:</AlertTitle>
    <AlertDescription>
      {hints.map((h) => (
        <div key={h.id} className="mt-2 p-2 bg-muted rounded">
          "{h.hint}"
          <div className="text-xs text-muted-foreground mt-1">
            {format(h.created_at, 'dd.MM.yyyy HH:mm')}
          </div>
        </div>
      ))}
    </AlertDescription>
  </Alert>
)}

<Textarea
  placeholder="Twoja odpowiedÅº (teÅ¼ anonimowa)..."
  onChange={(e) => setReply(e.target.value)}
/>
<Button onClick={sendReply}>Odpowiedz</Button>
```

**Uwaga:** Dwukierunkowa komunikacja moÅ¼e zdradziÄ‡ toÅ¼samoÅ›Ä‡ - consider making it one-way only (giver â†’ receiver).

### 5.5 Advanced Tooltips

**Biblioteka:** @radix-ui/react-tooltip (juÅ¼ w Shadcn)

**Use cases:**

1. **Exclusion Rules:**
```tsx
<TooltipProvider>
  <Tooltip>
    <TooltipTrigger asChild>
      <Button variant="ghost" size="icon">
        <HelpCircle className="h-4 w-4" />
      </Button>
    </TooltipTrigger>
    <TooltipContent>
      <p className="max-w-xs">
        ReguÅ‚y wykluczeÅ„ to ograniczenia typu "Osoba A nie moÅ¼e wylosowaÄ‡ Osoby B".
        UÅ¼yteczne dla par, rodzeÅ„stwa itp.
      </p>
    </TooltipContent>
  </Tooltip>
</TooltipProvider>
```

2. **Budget Guidance:**
```tsx
<Tooltip>
  <TooltipTrigger>BudÅ¼et: {budget} PLN (?)</TooltipTrigger>
  <TooltipContent>
    To sugerowana kwota na prezent. KaÅ¼dy uczestnik powinien kupiÄ‡ prezent
    w tej cenie (+/- 20%).
  </TooltipContent>
</Tooltip>
```

3. **Draw Algorithm:**
```tsx
<Tooltip>
  <TooltipTrigger>Jak dziaÅ‚a losowanie?</TooltipTrigger>
  <TooltipContent>
    System uÅ¼ywa algorytmu backtrackingowego, ktÃ³ry gwarantuje:
    - Nikt nie wylosuje siebie
    - Wszystkie wykluczenia sÄ… respektowane
    - KaÅ¼dy dostaje prezent od dokÅ‚adnie jednej osoby
  </TooltipContent>
</Tooltip>
```

### Deliverables FAZA 5
- âœ… Guided tour (Shepherd.js)
- âœ… Sample/demo groups
- âœ… Rich text wishlist editor (Tiptap)
- âœ… Drag & drop prioritization
- âœ… Price ranges dla items
- âœ… Gift inspirations (Allegro API)
- âœ… Emoji reactions (optional)
- âœ… Private notes dla organizatora
- âœ… Anonymous hints (optional)
- âœ… Enhanced tooltips

### Success Criteria
- >60% nowych uÅ¼ytkownikÃ³w koÅ„czy onboarding tour
- >50% wishlist uÅ¼ywa structured items (vs plain text)
- Users rate UX â‰¥4/5 stars
- Time to create first group <5 min

---

## ğŸ“Š FAZA 6: Analytics & Admin Dashboard
**Timeline:** TydzieÅ„ 19-22
**Priorytet:** ğŸŸ¢ NISKI (nice-to-have)

### Cele
Visibility dla organizatorÃ³w, data-driven decisions, power user features.

### 6.1 Group Analytics Dashboard

**Komponent:** `/src/components/group/GroupAnalytics.tsx`

**Metryki:**

1. **Participation Rate**
   - % osÃ³b ktÃ³re otworzyÅ‚y wyniki
   - Time to first view (median)
   - Ostatnia osoba ktÃ³ra nie zobaczyÅ‚a (ostrzeÅ¼enie)

2. **Wishlist Completion**
   - % uczestnikÃ³w z niepustÄ… wishlist
   - Avg wishlist length (characters/items)
   - Who hasn't added wishlist

3. **Engagement Timeline**
   - Chart: views over time
   - Peak viewing hours
   - Days until event

**UI:**

```tsx
<Card>
  <CardHeader>
    <CardTitle>ğŸ“Š Statystyki grupy</CardTitle>
  </CardHeader>
  <CardContent className="space-y-6">
    {/* Participation */}
    <div>
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-medium">Otwarli wyniki</span>
        <span className="text-2xl font-bold">{viewedCount}/{totalCount}</span>
      </div>
      <Progress value={(viewedCount / totalCount) * 100} />
      <p className="text-xs text-muted-foreground mt-1">
        {Math.round((viewedCount / totalCount) * 100)}% uczestnikÃ³w
      </p>
    </div>

    {/* Wishlist Completion */}
    <div>
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-medium">UzupeÅ‚nili wishlist</span>
        <span className="text-2xl font-bold">{wishlistCount}/{totalCount}</span>
      </div>
      <Progress value={(wishlistCount / totalCount) * 100} />
    </div>

    {/* Alerts */}
    {notViewedParticipants.length > 0 && (
      <Alert variant="warning">
        <AlertCircle className="h-4 w-4" />
        <AlertTitle>Nie wszyscy zobaczyli wyniki</AlertTitle>
        <AlertDescription>
          <ul className="list-disc pl-5 mt-2">
            {notViewedParticipants.map((p) => (
              <li key={p.id}>{p.name}</li>
            ))}
          </ul>
          <Button size="sm" variant="outline" className="mt-2">
            WyÅ›lij przypomnienie
          </Button>
        </AlertDescription>
      </Alert>
    )}

    {/* Timeline Chart */}
    <div>
      <h4 className="text-sm font-medium mb-3">Otwieranie wynikÃ³w</h4>
      <ResponsiveContainer width="100%" height={200}>
        <AreaChart data={viewsTimeline}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="date" />
          <YAxis />
          <Tooltip />
          <Area type="monotone" dataKey="views" stroke="#8884d8" fill="#8884d8" />
        </AreaChart>
      </ResponsiveContainer>
    </div>
  </CardContent>
</Card>
```

**Data queries:**

```typescript
// Get participation stats
const getGroupStats = async (groupId: string) => {
  const { data: participants } = await supabase
    .from('participants')
    .select('id, name, result_viewed_at, wishes(content)')
    .eq('group_id', groupId);

  const viewedCount = participants.filter((p) => p.result_viewed_at).length;
  const wishlistCount = participants.filter(
    (p) => p.wishes && p.wishes.content?.length > 20
  ).length;

  const notViewed = participants.filter((p) => !p.result_viewed_at);

  return {
    totalCount: participants.length,
    viewedCount,
    wishlistCount,
    notViewedParticipants: notViewed,
    participationRate: (viewedCount / participants.length) * 100,
  };
};

// Get views timeline
const getViewsTimeline = async (groupId: string) => {
  const { data } = await supabase
    .from('participants')
    .select('result_viewed_at')
    .eq('group_id', groupId)
    .not('result_viewed_at', 'is', null)
    .order('result_viewed_at');

  // Group by day
  const byDay = data.reduce((acc, p) => {
    const day = format(new Date(p.result_viewed_at), 'yyyy-MM-dd');
    acc[day] = (acc[day] || 0) + 1;
    return acc;
  }, {});

  return Object.entries(byDay).map(([date, views]) => ({ date, views }));
};
```

### 6.2 System-Wide Analytics (Super Admin)

**Use case:** JeÅ›li projekt wyroÅ›nie, dashboard dla admina

**Metryki:**

1. **User Stats**
   - Total registered users
   - Active users (last 30 days)
   - User growth chart

2. **Group Stats**
   - Total groups created
   - Avg participants per group
   - Groups with completed draws
   - Most popular group sizes

3. **Performance**
   - Avg draw execution time
   - Failed draws (impossible scenarios)
   - API response times

**Implementacja:**

```typescript
// Admin-only route: /admin/analytics
const getSystemStats = async () => {
  const [users, groups, draws] = await Promise.all([
    supabase.from('users').select('id, created_at'),
    supabase.from('groups').select('id, created_at, drawn_at'),
    supabase.from('draw_history').select('id, performed_at'),
  ]);

  return {
    totalUsers: users.data.length,
    activeUsersLast30Days: users.data.filter(
      (u) => new Date(u.created_at) > subDays(new Date(), 30)
    ).length,
    totalGroups: groups.data.length,
    completedDraws: groups.data.filter((g) => g.drawn_at).length,
    avgDrawsPerUser: draws.data.length / users.data.length,
  };
};
```

**Chart:** Recharts library (juÅ¼ uÅ¼ywane)

### 6.3 Export Functionality

#### CSV Export (Participants)

```typescript
async function exportParticipantsCSV(groupId: string) {
  const { data: participants } = await supabase
    .from('participants')
    .select('name, email, result_viewed_at, wishes(content)')
    .eq('group_id', groupId);

  const csv = [
    ['ImiÄ™', 'Email', 'ZobaczyÅ‚ wynik', 'Lista Å¼yczeÅ„'],
    ...participants.map((p) => [
      p.name,
      p.email || '',
      p.result_viewed_at ? 'Tak' : 'Nie',
      p.wishes?.content || '',
    ]),
  ]
    .map((row) => row.map((cell) => `"${cell}"`).join(','))
    .join('\n');

  // Download
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `participants-${groupId}.csv`;
  a.click();
}
```

**Button:**

```tsx
<Button onClick={() => exportParticipantsCSV(group.id)} variant="outline">
  <Download className="h-4 w-4 mr-2" />
  Eksportuj do CSV
</Button>
```

#### PDF Summary

**Biblioteka:** jsPDF lub React-PDF

```typescript
import jsPDF from 'jspdf';

async function exportGroupSummaryPDF(groupId: string) {
  const { data: group } = await supabase
    .from('groups')
    .select('*, participants(*)')
    .eq('id', groupId)
    .single();

  const doc = new jsPDF();

  // Title
  doc.setFontSize(20);
  doc.text(group.name, 20, 20);

  // Metadata
  doc.setFontSize(12);
  doc.text(`BudÅ¼et: ${group.budget} PLN`, 20, 40);
  doc.text(`Data: ${format(group.end_date, 'dd.MM.yyyy')}`, 20, 50);
  doc.text(`Uczestnicy: ${group.participants.length}`, 20, 60);

  // Participant list
  doc.setFontSize(14);
  doc.text('Lista uczestnikÃ³w:', 20, 80);

  group.participants.forEach((p, i) => {
    doc.setFontSize(10);
    doc.text(`${i + 1}. ${p.name}`, 25, 90 + i * 10);
  });

  doc.save(`group-${groupId}-summary.pdf`);
}
```

#### JSON Backup

**Use case:** Backup caÅ‚ej grupy (participants, exclusions, assignments, wishlists)

```typescript
async function exportGroupBackup(groupId: string) {
  const { data } = await supabase
    .from('groups')
    .select(`
      *,
      participants(*),
      exclusion_rules(*),
      assignments(*),
      wishes(*)
    `)
    .eq('id', groupId)
    .single();

  const json = JSON.stringify(data, null, 2);

  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `group-${groupId}-backup.json`;
  a.click();
}
```

### 6.4 Multi-Group Management

**Use case:** Power users zarzÄ…dzajÄ…cy wieloma grupami (np. coroczne Å›wiÄ™ta)

#### Bulk Actions

```tsx
<Card>
  <CardHeader>
    <CardTitle>ZarzÄ…dzanie wieloma grupami</CardTitle>
  </CardHeader>
  <CardContent>
    {/* Select groups */}
    <div className="space-y-2 mb-4">
      {groups.map((g) => (
        <div key={g.id} className="flex items-center gap-2">
          <Checkbox
            checked={selectedGroups.includes(g.id)}
            onCheckedChange={(checked) => toggleGroup(g.id, checked)}
          />
          <label>{g.name}</label>
        </div>
      ))}
    </div>

    {/* Bulk actions */}
    <div className="flex gap-2">
      <Button
        onClick={() => bulkDelete(selectedGroups)}
        variant="destructive"
        disabled={selectedGroups.length === 0}
      >
        UsuÅ„ zaznaczone ({selectedGroups.length})
      </Button>

      <Button
        onClick={() => bulkArchive(selectedGroups)}
        variant="outline"
        disabled={selectedGroups.length === 0}
      >
        Archiwizuj
      </Button>
    </div>
  </CardContent>
</Card>
```

#### Group Templates

**Use case:** Skopiuj ustawienia z zeszÅ‚orocznej grupy

**Tabela:** `group_templates`

```sql
CREATE TABLE group_templates (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  budget INTEGER NOT NULL,
  participants_template JSONB, -- [{name, email}, ...]
  exclusions_template JSONB,   -- [{nameA, nameB}, ...]
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**UI:**

```tsx
<Dialog>
  <DialogTrigger asChild>
    <Button variant="outline">UÅ¼yj szablonu</Button>
  </DialogTrigger>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Wybierz szablon</DialogTitle>
    </DialogHeader>

    <div className="space-y-2">
      {templates.map((t) => (
        <Card
          key={t.id}
          className="cursor-pointer hover:bg-accent"
          onClick={() => applyTemplate(t)}
        >
          <CardContent className="p-4">
            <div className="font-medium">{t.name}</div>
            <div className="text-sm text-muted-foreground">
              {t.participants_template.length} uczestnikÃ³w â€¢ {t.budget} PLN
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  </DialogContent>
</Dialog>
```

**Apply Template:**

```typescript
async function applyTemplate(templateId: string, newGroupId: string) {
  const { data: template } = await supabase
    .from('group_templates')
    .select('*')
    .eq('id', templateId)
    .single();

  // Add participants
  const participantInserts = template.participants_template.map((p) => ({
    group_id: newGroupId,
    name: p.name,
    email: p.email,
    access_token: nanoid(32),
  }));

  const { data: newParticipants } = await supabase
    .from('participants')
    .insert(participantInserts)
    .select();

  // Add exclusions (map names to new participant IDs)
  const nameToId = Object.fromEntries(
    newParticipants.map((p) => [p.name, p.id])
  );

  const exclusionInserts = template.exclusions_template.map((e) => ({
    group_id: newGroupId,
    participant_a_id: nameToId[e.nameA],
    participant_b_id: nameToId[e.nameB],
  }));

  await supabase.from('exclusion_rules').insert(exclusionInserts);
}
```

**Save as Template:**

```tsx
<Button onClick={saveAsTemplate}>
  Zapisz jako szablon
</Button>
```

#### Archive Groups

**Use case:** Ukryj stare grupy z dashboard bez usuwania

```sql
ALTER TABLE groups
ADD COLUMN archived_at TIMESTAMPTZ;
```

**Filter:**

```typescript
// Show only active groups by default
const { data: groups } = await supabase
  .from('groups')
  .select('*')
  .is('archived_at', null)
  .order('created_at', { ascending: false });

// Option to show archived
<Toggle
  pressed={showArchived}
  onPressedChange={setShowArchived}
>
  PokaÅ¼ zarchiwizowane
</Toggle>
```

### Deliverables FAZA 6
- âœ… Group analytics dashboard (participation, wishlists, timeline)
- âœ… System-wide analytics (optional, admin only)
- âœ… CSV/PDF/JSON export
- âœ… Bulk actions (delete, archive)
- âœ… Group templates
- âœ… Archive functionality

### Success Criteria
- Organizatorzy regularnie sprawdzajÄ… analytics
- >30% grup uÅ¼ywa templates
- Zero data loss during exports
- Power users manage 5+ groups efficiently

---

## ğŸŒ FAZA 7: Internationalization (Opcjonalna)
**Timeline:** TydzieÅ„ 23-26
**Priorytet:** ğŸ”µ BARDZO NISKI (stretch goal)

### Cele
DostÄ™pnoÅ›Ä‡ dla miÄ™dzynarodowych grup, rozszerzenie user base poza PolskÄ™.

### 7.1 Multi-Language Support

**Framework:** Astro i18n integration

```bash
npm install astro-i18n
```

**Config:** `astro.config.mjs`

```javascript
import { defineConfig } from 'astro/config';
import i18n from 'astro-i18n';

export default defineConfig({
  integrations: [
    i18n({
      defaultLocale: 'pl',
      locales: ['pl', 'en', 'de', 'fr'],
    }),
  ],
});
```

**Translations:** `/src/locales/`

```
/src/locales/
â”œâ”€â”€ pl.json
â”œâ”€â”€ en.json
â”œâ”€â”€ de.json
â””â”€â”€ fr.json
```

**pl.json:**
```json
{
  "common": {
    "appName": "Secret Santa",
    "loading": "Åadowanie...",
    "save": "Zapisz",
    "cancel": "Anuluj",
    "delete": "UsuÅ„"
  },
  "dashboard": {
    "title": "Pulpit",
    "myGroups": "Moje grupy",
    "joinedGroups": "Grupy do ktÃ³rych naleÅ¼Ä™",
    "createGroup": "UtwÃ³rz nowÄ… grupÄ™"
  },
  "group": {
    "name": "Nazwa grupy",
    "budget": "BudÅ¼et",
    "endDate": "Data zakoÅ„czenia",
    "participants": "Uczestnicy",
    "draw": "Losowanie",
    "result": "Wynik"
  }
}
```

**en.json:**
```json
{
  "common": {
    "appName": "Secret Santa",
    "loading": "Loading...",
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete"
  },
  "dashboard": {
    "title": "Dashboard",
    "myGroups": "My Groups",
    "joinedGroups": "Groups I'm In",
    "createGroup": "Create New Group"
  },
  "group": {
    "name": "Group Name",
    "budget": "Budget",
    "endDate": "End Date",
    "participants": "Participants",
    "draw": "Draw",
    "result": "Result"
  }
}
```

**Usage:**

```tsx
import { useTranslation } from 'astro-i18n';

export function Dashboard() {
  const t = useTranslation();

  return (
    <div>
      <h1>{t('dashboard.title')}</h1>
      <Button>{t('dashboard.createGroup')}</Button>
    </div>
  );
}
```

**Language Switcher:**

```tsx
<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="outline">
      <Globe className="h-4 w-4 mr-2" />
      {currentLocale.toUpperCase()}
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    <DropdownMenuItem onClick={() => changeLocale('pl')}>
      ğŸ‡µğŸ‡± Polski
    </DropdownMenuItem>
    <DropdownMenuItem onClick={() => changeLocale('en')}>
      ğŸ‡¬ğŸ‡§ English
    </DropdownMenuItem>
    <DropdownMenuItem onClick={() => changeLocale('de')}>
      ğŸ‡©ğŸ‡ª Deutsch
    </DropdownMenuItem>
    <DropdownMenuItem onClick={() => changeLocale('fr')}>
      ğŸ‡«ğŸ‡· FranÃ§ais
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

**Email Templates:**

RÃ³Å¼ne wersje dla kaÅ¼dego jÄ™zyka:

```
/src/emails/templates/
â”œâ”€â”€ en/
â”‚   â”œâ”€â”€ WelcomeEmail.tsx
â”‚   â””â”€â”€ DrawCompletedEmail.tsx
â”œâ”€â”€ pl/
â”‚   â”œâ”€â”€ WelcomeEmail.tsx
â”‚   â””â”€â”€ DrawCompletedEmail.tsx
...
```

### 7.2 Multi-Currency

**Database:**

```sql
ALTER TABLE groups
ADD COLUMN currency VARCHAR(3) DEFAULT 'PLN'
  CHECK (currency IN ('PLN', 'USD', 'EUR', 'GBP'));
```

**Currency Selector:**

```tsx
<Select value={currency} onValueChange={setCurrency}>
  <SelectTrigger>
    <SelectValue placeholder="Waluta" />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="PLN">PLN (zÅ‚oty polski)</SelectItem>
    <SelectItem value="USD">USD (US dollar)</SelectItem>
    <SelectItem value="EUR">EUR (euro)</SelectItem>
    <SelectItem value="GBP">GBP (British pound)</SelectItem>
  </SelectContent>
</Select>
```

**Formatowanie:**

```typescript
function formatCurrency(amount: number, currency: string, locale: string) {
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency,
  }).format(amount);
}

// Usage
formatCurrency(100, 'PLN', 'pl-PL'); // "100,00 zÅ‚"
formatCurrency(100, 'USD', 'en-US'); // "$100.00"
formatCurrency(100, 'EUR', 'de-DE'); // "100,00 â‚¬"
```

**Currency Conversion (opcjonalne):**

```typescript
// API: exchangerate.host (free)
async function convertCurrency(amount: number, from: string, to: string) {
  const response = await fetch(
    `https://api.exchangerate.host/convert?from=${from}&to=${to}&amount=${amount}`
  );
  const data = await response.json();
  return data.result;
}

// Show converted amount in user's preferred currency
<Tooltip>
  <TooltipTrigger>
    {formatCurrency(group.budget, group.currency, locale)}
  </TooltipTrigger>
  <TooltipContent>
    W Twojej walucie: ~{formatCurrency(converted, userCurrency, locale)}
  </TooltipContent>
</Tooltip>
```

### 7.3 Date/Time Localization

**Biblioteka:** date-fns (juÅ¼ w projekcie)

```typescript
import { format } from 'date-fns';
import { pl, enUS, de, fr } from 'date-fns/locale';

const localeMap = {
  pl,
  en: enUS,
  de,
  fr,
};

function formatDate(date: Date, pattern: string, locale: string) {
  return format(date, pattern, { locale: localeMap[locale] });
}

// Usage
formatDate(new Date(), 'PPP', 'pl');  // "3 listopada 2025"
formatDate(new Date(), 'PPP', 'en');  // "November 3rd, 2025"
formatDate(new Date(), 'PPP', 'de');  // "3. November 2025"
```

### 7.4 RTL Support (opcjonalnie dla arabskiego)

JeÅ›li w przyszÅ‚oÅ›ci dodanie jÄ™zykÃ³w RTL (Arabic, Hebrew):

```css
[dir='rtl'] {
  direction: rtl;
}

[dir='rtl'] .flex {
  flex-direction: row-reverse;
}
```

### Deliverables FAZA 7
- âœ… i18n framework integration
- âœ… Translations dla 4 jÄ™zykÃ³w (PL, EN, DE, FR)
- âœ… Language switcher UI
- âœ… Multi-currency support
- âœ… Localized date/time formatting
- âœ… Translated email templates

### Success Criteria
- App fully functional in all 4 languages
- Zero untranslated strings
- Currency formatting correct per locale
- >10% users use non-Polish language

---

## Metryki sukcesu

### Po 3 miesiÄ…cach (Fazy 1-4)

**FunkcjonalnoÅ›Ä‡:**
- âœ… System email dziaÅ‚a z >95% delivery rate
- âœ… 80% grup uÅ¼ywa invite links
- âœ… Re-draw feature dostÄ™pny i przetestowany

**Technical Health:**
- âœ… 100% testÃ³w przechodzi w CI/CD
- âœ… Coverage â‰¥70%
- âœ… RLS enabled i secure
- âœ… Zero critical bugs

**User Engagement:**
- âœ… 90% uczestnikÃ³w otwiera wyniki w ciÄ…gu 48h
- âœ… 70% uzupeÅ‚nia wishlist
- âœ… Åšrednio 8-12 uczestnikÃ³w na grupÄ™

### Po 6 miesiÄ…cach (Fazy 1-7)

**Feature Adoption:**
- âœ… 60% uÅ¼ytkownikÃ³w uÅ¼ywa structured wishlists
- âœ… 40% grup korzysta z templates
- âœ… 20% grup wykonaÅ‚o re-draw
- âœ… >50% uÅ¼ytkownikÃ³w wÅ‚Ä…cza email notifications

**Growth:**
- âœ… 100+ active users
- âœ… 50+ completed draws
- âœ… Users create 2+ groups on average

**Quality:**
- âœ… <2s load time dla wszystkich stron
- âœ… >4.5/5 user satisfaction
- âœ… <1% error rate

---

## Rekomendacje

### Priorytetyzacja

**MUST HAVE (Faza 1):**
- BezpieczeÅ„stwo: RLS, testy w CI
- Fundament dla dalszego rozwoju

**HIGH PRIORITY (Fazy 2-3):**
- Email notifications - najwiÄ™kszy impact na UX
- Invite system - redukcja friction dla organizatorÃ³w

**MEDIUM PRIORITY (Fazy 4-5):**
- Re-draw - edge case ale waÅ¼ny dla elastycznoÅ›ci
- UX improvements - nice-to-have dla engagement

**LOW PRIORITY (Fazy 6-7):**
- Analytics - uÅ¼yteczne dla power users
- i18n - tylko jeÅ›li planowane miÄ™dzynarodowe uÅ¼ycie

### Quick Wins (pierwsze 2 tygodnie)

1. **Enable RLS** - 1 dzieÅ„ pracy, ogromny security boost
2. **Uncomment tests in CI** - 2 godziny, instant quality gate
3. **Add coverage reporting** - 4 godziny, visibility
4. **Sample groups** - 1 dzieÅ„, lepszy onboarding

### DÅ‚ugoterminowa wizja

**Rok 1:** Wszystkie 7 faz + stabilna baza uÅ¼ytkownikÃ³w
**Rok 2:**
- Mobile app (PWA â†’ Native)
- Advanced matching (preferences beyond exclusions)
- Gamification (badges, achievements)
- Marketplace integration (buy gifts in-app)

---

## Podsumowanie

Projekt Secret Santa ma **doskonaÅ‚e fundamenty** (85-90% MVP complete) i jest gotowy do rozbudowy. Zaproponowana roadmapa na 3-6 miesiÄ™cy skupia siÄ™ na:

1. **BezpieczeÅ„stwie i stabilnoÅ›ci** (Faza 1) - absolutny priorytet
2. **Automatyzacji i skalowaniu** (Fazy 2-3) - email + invites
3. **ElastycznoÅ›ci** (Faza 4) - re-draw capability
4. **User Experience** (Faza 5) - wishlist improvements, onboarding
5. **Data-driven decisions** (Faza 6) - analytics
6. **Global reach** (Faza 7) - opcjonalna internacjonalizacja

**Rekomendowane podejÅ›cie:**
- Start z **FazÄ… 1** (2 tygodnie, krytyczna)
- Iteracyjnie wdraÅ¼aj **Fazy 2-3** (2 miesiÄ…ce, high ROI)
- Oceniaj feedback uÅ¼ytkownikÃ³w przed **Fazami 4-7**

Sukces projektu bÄ™dzie mierzony nie tylko liczbÄ… funkcji, ale **jakoÅ›ciÄ… doÅ›wiadczenia** uÅ¼ytkownikÃ³w oraz **stabilnoÅ›ciÄ…** systemu. Obecna architektura pozwala na skalowanie bez rewrites - co jest wielkim osiÄ…gniÄ™ciem dla MVP.

**GotowoÅ›Ä‡ do startu:** âœ… **100%** (po Fazie 1)

---

**Dokument przygotowany:** 2025-11-03
**PrzygotowaÅ‚:** Claude Code (Sonnet 4.5) jako Product Manager
**Wersja:** 1.0
**Status:** Ready for implementation
