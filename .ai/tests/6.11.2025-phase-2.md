# Plan TestÃ³w Jednostkowych - Faza 2
**Data:** 6 listopada 2025
**Autor:** Specjalista ds. testÃ³w
**Status:** Zaplanowane

---

## ğŸ“Š RAPORT POKRYCIA TESTAMI - SECRET SANTA

### Aktualny stan pokrycia:
- âœ… **Auth layer**: 100% (439 testÃ³w - COMPLETED)
- âŒ **Services**: 14% (1/7 plikÃ³w z testami)
- âŒ **API Endpoints**: 0% (0/17 plikÃ³w z testami)
- âŒ **Hooks**: 0% (0/20 plikÃ³w z testami)
- âŒ **Components**: 10% (4/40+ plikÃ³w z testami)
- âŒ **Utils**: 20% (1/5 plikÃ³w z testami)
- âŒ **Schemas**: 40% (czÄ™Å›ciowe pokrycie)

### ğŸ“ˆ Statystyki globalne:
- **Pliki z testami**: 20
- **Pliki bez testÃ³w**: 131+
- **Linii kodu bez testÃ³w**: ~11,800+
- **CaÅ‚kowite pokrycie**: ~15-20%

### ğŸ¯ Cel: ZwiÄ™kszyÄ‡ pokrycie do 85-90%

---

## ğŸ¯ PLAN TESTÃ“W - 4 FAZY

### **FAZA 1: CRITICAL SERVICES** âš ï¸
**Priorytet:** NAJWYÅ»SZY
**Czas:** 3-4 godziny
**WpÅ‚yw:** KRYTYCZNY - Core business logic

#### 1.1. draw.service.ts (325 LOC)
**Dlaczego:** Algorytm losowania Secret Santa - najwaÅ¼niejsza logika biznesowa

**Obszary testowania:**
- Algorytm backtracking
- Walidacja reguÅ‚ wykluczeÅ„
- Timeout handling (15s)
- Gwarancja poufnoÅ›ci losowania
- Single Hamiltonian cycle
- Cross-pairs handling
- Randomness verification

**Testy do dodania (~40-50 testÃ³w):**

```typescript
describe("DrawService")

  describe("executeDrawAlgorithm")
    // Happy path
    âœ“ Should successfully draw with 3 participants
    âœ“ Should successfully draw with 6 participants
    âœ“ Should successfully draw with 10 participants
    âœ“ Should work with valid exclusion rules
    âœ“ Should generate different results on multiple runs (randomness)

    // Exclusion rules
    âœ“ Should respect one-way exclusions (A cannot draw B)
    âœ“ Should respect multiple exclusions per participant
    âœ“ Should handle complex exclusion chains
    âœ“ Should prevent impossible exclusion configurations
    âœ“ Should detect deadlock scenarios
    âœ“ Should reject when all participants excluded from each other

    // Self-assignment
    âœ“ Should never assign participant to themselves
    âœ“ Should validate no self-loops in result

    // Cycle structure
    âœ“ Should create single Hamiltonian cycle
    âœ“ Should allow cross-pairs (Aâ†’B, Bâ†’A) for randomness
    âœ“ Should handle various cycle structures (2+4, 3+3, etc)

    // Edge cases
    âœ“ Should handle minimum participants (3)
    âœ“ Should handle maximum exclusions
    âœ“ Should timeout after 15 seconds
    âœ“ Should throw error on timeout
    âœ“ Should handle empty exclusions array

    // Data validation
    âœ“ Should validate participant IDs exist
    âœ“ Should validate exclusion participant IDs exist
    âœ“ Should reject invalid input structure

  describe("validateDrawPossibility")
    âœ“ Should return true for valid configuration
    âœ“ Should return false for impossible exclusions
    âœ“ Should return false for circular exclusions
    âœ“ Should return true for empty exclusions
    âœ“ Should handle edge case: everyone excludes one person
    âœ“ Should validate minimum participants (3)

  describe("generateAssignments")
    âœ“ Should create correct assignments structure
    âœ“ Should include all participants exactly once
    âœ“ Should have no duplicate givers
    âœ“ Should have no duplicate receivers
    âœ“ Should map participant IDs to assignment IDs
    âœ“ Should generate valid database records

  describe("Integration tests")
    âœ“ Should handle full draw workflow
    âœ“ Should rollback on partial failure
    âœ“ Should log draw execution
```

**Scenariusze testowe:**

1. **Valid draw scenarios**
   - 3 participants, no exclusions â†’ Success
   - 6 participants, 2 exclusions â†’ Success
   - 10 participants, complex exclusions â†’ Success

2. **Invalid draw scenarios**
   - 2 participants â†’ Error (minimum 3)
   - Impossible exclusions â†’ Error with explanation
   - All mutual exclusions â†’ Error (deadlock)

3. **Randomness validation**
   - 100 runs with same input â†’ Different results
   - Distribution of cycle structures
   - No deterministic patterns

4. **Performance**
   - Draw completes under 1 second for 10 participants
   - Timeout handling for impossible scenarios

---

#### 1.2. group.service.ts (650 LOC)
**Dlaczego:** ZarzÄ…dzanie grupami - CRUD + auto-add creator

**Testy do dodania (~35-40 testÃ³w):**

```typescript
describe("GroupService")

  describe("createGroup")
    // Success scenarios
    âœ“ Should create group with valid data
    âœ“ Should auto-add creator as first participant
    âœ“ Should return group with creator participant
    âœ“ Should set correct initial state (not drawn)
    âœ“ Should save budget and end date

    // Validation
    âœ“ Should validate name is required
    âœ“ Should validate budget > 0
    âœ“ Should validate end date is in future
    âœ“ Should reject past end date
    âœ“ Should reject invalid currency
    âœ“ Should trim and sanitize name

    // Database errors
    âœ“ Should handle database connection error
    âœ“ Should rollback on participant creation failure
    âœ“ Should throw specific error codes

    // Edge cases
    âœ“ Should handle very long group names (255 chars)
    âœ“ Should handle maximum budget value
    âœ“ Should handle minimum budget (1)
    âœ“ Should handle end date far in future (1 year+)

  describe("updateGroup")
    // Success scenarios
    âœ“ Should update group name
    âœ“ Should update budget
    âœ“ Should update end date
    âœ“ Should update multiple fields at once

    // Authorization
    âœ“ Should allow only creator to update
    âœ“ Should reject non-creator updates (403)
    âœ“ Should reject unauthenticated updates (401)

    // State validation
    âœ“ Should reject updates after draw
    âœ“ Should allow updates before draw
    âœ“ Should prevent changing creator_user_id

    // Validation
    âœ“ Should validate new budget > 0
    âœ“ Should validate new end date in future
    âœ“ Should validate name not empty

    // Database errors
    âœ“ Should handle update failure
    âœ“ Should return 404 if group not found

  describe("deleteGroup")
    // Success scenarios
    âœ“ Should delete group and cascade to participants
    âœ“ Should delete group and cascade to exclusions
    âœ“ Should delete group and cascade to assignments
    âœ“ Should delete group and cascade to wishlists

    // Authorization
    âœ“ Should allow only creator to delete
    âœ“ Should reject non-creator deletes (403)

    // Confirmation
    âœ“ Should require confirmation parameter
    âœ“ Should reject without confirmation

    // Edge cases
    âœ“ Should handle group with active draw
    âœ“ Should handle group with many participants (100+)
    âœ“ Should return 404 if group not found

  describe("getGroupById")
    // Success scenarios
    âœ“ Should return group with all participants
    âœ“ Should return group with exclusion rules
    âœ“ Should return group with draw status
    âœ“ Should include creator information

    // Access control
    âœ“ Should allow creator to view
    âœ“ Should allow participants to view
    âœ“ Should reject non-members (403)

    // Not found
    âœ“ Should return 404 for non-existent group
    âœ“ Should return 404 for deleted group

    // Performance
    âœ“ Should load efficiently with eager loading
    âœ“ Should not N+1 query participants

  describe("listGroups")
    âœ“ Should list groups created by user
    âœ“ Should list groups where user is participant
    âœ“ Should paginate results
    âœ“ Should sort by creation date
    âœ“ Should filter by status (drawn/not drawn)
```

**Mock data examples:**
```typescript
const mockGroup = {
  id: 1,
  name: "Christmas Secret Santa 2025",
  budget: 50,
  currency: "PLN",
  end_date: "2025-12-24",
  creator_user_id: "user-123",
  is_drawn: false,
  created_at: "2025-11-01T10:00:00Z"
};

const mockCreatorParticipant = {
  id: 1,
  group_id: 1,
  name: "John Doe",
  email: "john@example.com",
  user_id: "user-123",
  is_registered: true
};
```

---

#### 1.3. participant.service.ts (769 LOC)
**Dlaczego:** NajwiÄ™kszy serwis - zarzÄ…dzanie uczestnikami

**Testy do dodania (~45-50 testÃ³w):**

```typescript
describe("ParticipantService")

  describe("addParticipant")
    // Registered users
    âœ“ Should add participant with email (registered)
    âœ“ Should link to existing user account
    âœ“ Should set is_registered = true

    // Unregistered users
    âœ“ Should add participant without email
    âœ“ Should generate participant token
    âœ“ Should set is_registered = false
    âœ“ Should create unique token per participant

    // Email validation
    âœ“ Should validate email format
    âœ“ Should validate email uniqueness in group
    âœ“ Should reject duplicate emails in same group
    âœ“ Should allow same email in different groups
    âœ“ Should be case-insensitive for email comparison

    // Authorization
    âœ“ Should allow only group creator to add
    âœ“ Should reject non-creator additions (403)

    // State validation
    âœ“ Should reject additions after draw
    âœ“ Should allow additions before draw

    // Business rules
    âœ“ Should enforce minimum 3 participants for draw
    âœ“ Should allow adding beyond minimum
    âœ“ Should not enforce maximum participant limit

    // Data validation
    âœ“ Should validate name is required
    âœ“ Should validate name length (min 2, max 100)
    âœ“ Should trim whitespace from name
    âœ“ Should reject empty name after trim

    // Database errors
    âœ“ Should handle database errors gracefully
    âœ“ Should return specific error codes

  describe("updateParticipant")
    // Success scenarios
    âœ“ Should update participant name
    âœ“ Should update participant email
    âœ“ Should update both name and email

    // Email uniqueness
    âœ“ Should validate new email uniqueness
    âœ“ Should reject duplicate email in same group
    âœ“ Should allow keeping same email (no change)

    // Authorization
    âœ“ Should allow only creator to update
    âœ“ Should reject non-creator updates (403)

    // State validation
    âœ“ Should reject updates after draw
    âœ“ Should allow updates before draw

    // Special cases
    âœ“ Should not change user_id if email changed
    âœ“ Should preserve participant token
    âœ“ Should preserve is_registered status

    // Validation
    âœ“ Should validate name not empty
    âœ“ Should validate email format if provided

    // Not found
    âœ“ Should return 404 if participant not found

  describe("deleteParticipant")
    // Success scenarios
    âœ“ Should delete participant
    âœ“ Should cascade delete from exclusion rules
    âœ“ Should remove as giver in exclusions
    âœ“ Should remove as receiver in exclusions

    // Business rules
    âœ“ Should enforce minimum 3 participants
    âœ“ Should reject delete if only 3 participants left
    âœ“ Should allow delete if more than 3 remain

    // Authorization
    âœ“ Should allow only creator to delete
    âœ“ Should reject non-creator deletes (403)

    // State validation
    âœ“ Should reject deletes after draw
    âœ“ Should allow deletes before draw

    // Special cases
    âœ“ Should not delete creator participant
    âœ“ Should handle participant with wishlists
    âœ“ Should handle participant in assignments

    // Not found
    âœ“ Should return 404 if participant not found

  describe("validateEmailUniqueness")
    âœ“ Should return true for unique email
    âœ“ Should return false for duplicate email
    âœ“ Should be case-insensitive
    âœ“ Should ignore whitespace
    âœ“ Should scope to group only
    âœ“ Should allow null/empty email (unregistered)
    âœ“ Should handle emails with special characters

  describe("generateParticipantToken")
    âœ“ Should generate cryptographically secure token
    âœ“ Should generate unique tokens
    âœ“ Should have sufficient entropy (32+ chars)
    âœ“ Should use URL-safe characters

  describe("getParticipantsByGroup")
    âœ“ Should list all participants in group
    âœ“ Should include registered and unregistered
    âœ“ Should order by creation date
    âœ“ Should include user information for registered
    âœ“ Should not expose tokens in listing
```

**Test fixtures:**
```typescript
const mockParticipants = [
  {
    id: 1,
    group_id: 1,
    name: "Alice (Creator)",
    email: "alice@example.com",
    user_id: "user-123",
    is_registered: true,
    participant_token: null
  },
  {
    id: 2,
    group_id: 1,
    name: "Bob (Registered)",
    email: "bob@example.com",
    user_id: "user-456",
    is_registered: true,
    participant_token: null
  },
  {
    id: 3,
    group_id: 1,
    name: "Charlie (Unregistered)",
    email: null,
    user_id: null,
    is_registered: false,
    participant_token: "secure-token-abc123"
  }
];
```

---

#### 1.4. exclusion-rule.service.ts (419 LOC)
**Dlaczego:** Logika wykluczeÅ„ - kluczowa dla algorytmu losowania

**Testy do dodania (~30-35 testÃ³w):**

```typescript
describe("ExclusionRuleService")

  describe("addExclusionRule")
    // Success scenarios
    âœ“ Should create one-way exclusion (A cannot draw B)
    âœ“ Should create exclusion with valid participants
    âœ“ Should save to database with correct IDs

    // Validation
    âœ“ Should validate giver_id exists in group
    âœ“ Should validate receiver_id exists in group
    âœ“ Should validate giver and receiver are different
    âœ“ Should reject self-exclusion (A â†’ A)
    âœ“ Should validate both in same group

    // Duplicate prevention
    âœ“ Should prevent duplicate rules (same giverâ†’receiver)
    âœ“ Should allow reverse rule (Aâ†’B exists, add Bâ†’A)

    // Draw possibility validation
    âœ“ Should validate draw is still possible after add
    âœ“ Should reject if exclusion makes draw impossible
    âœ“ Should detect deadlock scenarios
    âœ“ Should check graph connectivity

    // Authorization
    âœ“ Should allow only group creator to add
    âœ“ Should reject non-creator additions (403)

    // State validation
    âœ“ Should reject additions after draw
    âœ“ Should allow additions before draw

    // Database errors
    âœ“ Should handle foreign key violations
    âœ“ Should handle constraint violations

  describe("removeExclusionRule")
    // Success scenarios
    âœ“ Should delete exclusion rule
    âœ“ Should return success message

    // Authorization
    âœ“ Should allow only creator to delete
    âœ“ Should reject non-creator deletes (403)

    // State validation
    âœ“ Should reject deletes after draw
    âœ“ Should allow deletes before draw

    // Not found
    âœ“ Should return 404 if rule not found
    âœ“ Should handle already deleted rule

  describe("getExclusionsByGroup")
    âœ“ Should list all exclusions for group
    âœ“ Should include participant names
    âœ“ Should order by creation date
    âœ“ Should return empty array if no exclusions
    âœ“ Should filter by group_id correctly

  describe("validateExclusionsForDraw")
    // Valid configurations
    âœ“ Should return success for no exclusions
    âœ“ Should return success for simple exclusion (Aâ†’B)
    âœ“ Should return success for complex valid setup

    // Invalid configurations
    âœ“ Should detect impossible exclusions
    âœ“ Should detect when participant has no valid targets
    âœ“ Should detect circular deadlocks
    âœ“ Should provide detailed error messages
    âœ“ Should list problematic participants

    // Edge cases
    âœ“ Should handle all-to-one exclusions
    âœ“ Should handle one-to-all exclusions
    âœ“ Should validate with minimum participants (3)

  describe("Graph validation helpers")
    âœ“ Should build adjacency matrix correctly
    âœ“ Should detect strongly connected components
    âœ“ Should find Hamiltonian path if exists
    âœ“ Should detect impossible configurations early
```

**Complex test scenario:**
```typescript
// Deadlock scenario: Aâ†’B, Bâ†’C, Câ†’A (3 participants)
// This creates impossible draw because no valid cycle exists
const impossibleExclusions = [
  { giver_id: 1, receiver_id: 2 }, // A cannot draw B
  { giver_id: 2, receiver_id: 3 }, // B cannot draw C
  { giver_id: 3, receiver_id: 1 }  // C cannot draw A
];
// Expected: validateExclusionsForDraw() returns errors

// Valid scenario: Aâ†’B (4 participants)
const validExclusions = [
  { giver_id: 1, receiver_id: 2 }
];
// Expected: validateExclusionsForDraw() returns success
// Possible cycles: Aâ†’Câ†’Dâ†’Bâ†’A, Aâ†’Dâ†’Câ†’Bâ†’A, etc.
```

---

### **Oszacowanie Fazy 1:**
- **Liczba testÃ³w:** 150-175 testÃ³w
- **Czas realizacji:** 3-4 godziny
- **Pliki:** 4 serwisy (draw, group, participant, exclusion-rule)
- **Linii kodu testowanego:** ~2,100 LOC
- **Pokrycie po fazie:** Services 86% â†’ 100%

**Struktura plikÃ³w testowych:**
```
src/lib/services/__tests__/
â”œâ”€â”€ draw.service.test.ts        (40-50 tests, ~1,200 LOC)
â”œâ”€â”€ group.service.test.ts       (35-40 tests, ~900 LOC)
â”œâ”€â”€ participant.service.test.ts (45-50 tests, ~1,100 LOC)
â””â”€â”€ exclusion-rule.service.test.ts (30-35 tests, ~800 LOC)
```

---

## **FAZA 2: CRITICAL API ENDPOINTS** ğŸ”
**Priorytet:** WYSOKI
**Czas:** 3-4 godziny
**WpÅ‚yw:** SECURITY + FUNKCJONALNOÅšÄ†

### Dlaczego API endpoints sÄ… krytyczne:
- **Security**: Autentykacja, autoryzacja, input validation
- **Data integrity**: Atomowe operacje, transakcje
- **User experience**: Error handling, status codes
- **Contract testing**: API zachowuje zgodnoÅ›Ä‡ z frontendem

---

#### 2.1. /api/groups/[groupId]/draw.ts (~100 LOC)
**Dlaczego:** GÅ‚Ã³wny endpoint losowania - najbardziej krytyczna operacja

**Testy do dodania (~25-30 testÃ³w):**

```typescript
describe("POST /api/groups/[groupId]/draw")

  describe("Success scenarios")
    âœ“ Should execute draw and return 200
    âœ“ Should save assignments to database
    âœ“ Should generate participant tokens
    âœ“ Should set group.is_drawn = true
    âœ“ Should return success message with draw_id
    âœ“ Should complete in under 5 seconds

  describe("Authentication")
    âœ“ Should require authenticated user (401)
    âœ“ Should reject expired session
    âœ“ Should validate JWT token

  describe("Authorization")
    âœ“ Should allow only group creator (403)
    âœ“ Should reject if user is not creator
    âœ“ Should reject if user is only participant

  describe("Validation - Insufficient participants")
    âœ“ Should reject with < 3 participants (400)
    âœ“ Should return clear error message
    âœ“ Should list current participant count

  describe("Validation - Already drawn")
    âœ“ Should reject if group.is_drawn = true (400)
    âœ“ Should return error message "Draw already executed"
    âœ“ Should not create duplicate assignments

  describe("Validation - Impossible exclusions")
    âœ“ Should validate exclusions before draw (400)
    âœ“ Should return detailed validation errors
    âœ“ Should list problematic exclusion rules
    âœ“ Should suggest fixing exclusions

  describe("Error handling - Timeout")
    âœ“ Should timeout after 15 seconds (500)
    âœ“ Should rollback any partial changes
    âœ“ Should log timeout error
    âœ“ Should return clear error message

  describe("Error handling - Database")
    âœ“ Should handle database connection error (500)
    âœ“ Should rollback on assignment save failure
    âœ“ Should maintain data consistency
    âœ“ Should log database errors

  describe("Atomicity")
    âœ“ Should rollback if any step fails
    âœ“ Should not partially update database
    âœ“ Should use database transactions

  describe("Token generation")
    âœ“ Should generate unique tokens for unregistered users
    âœ“ Should not generate tokens for registered users
    âœ“ Should save tokens with participants

  describe("Edge cases")
    âœ“ Should handle exactly 3 participants
    âœ“ Should handle 50+ participants
    âœ“ Should handle maximum exclusion rules
```

**Test request/response examples:**
```typescript
// Success request
const successRequest = {
  method: 'POST',
  url: '/api/groups/1/draw',
  headers: {
    'Authorization': 'Bearer valid-jwt-token',
    'Content-Type': 'application/json'
  }
};

// Expected response
const successResponse = {
  status: 200,
  body: {
    success: true,
    message: "Draw executed successfully",
    draw_id: 123,
    participants_count: 6,
    assignments_created: 6
  }
};

// Error response - insufficient participants
const errorResponse400 = {
  status: 400,
  body: {
    error: "INSUFFICIENT_PARTICIPANTS",
    message: "At least 3 participants required for draw",
    current_count: 2,
    required_count: 3
  }
};

// Error response - timeout
const errorResponse500 = {
  status: 500,
  body: {
    error: "DRAW_TIMEOUT",
    message: "Draw algorithm timed out after 15 seconds",
    suggestion: "Please check exclusion rules and try again"
  }
};
```

---

#### 2.2. /api/groups/[groupId]/index.ts (CRUD operations)
**Dlaczego:** GÅ‚Ã³wny endpoint zarzÄ…dzania grupami

**Testy do dodania (~20-25 testÃ³w):**

```typescript
describe("GET /api/groups/[groupId]")
  âœ“ Should return group with participants (200)
  âœ“ Should include creator information
  âœ“ Should include exclusion rules
  âœ“ Should include draw status
  âœ“ Should require authentication (401)
  âœ“ Should check membership (403)
  âœ“ Should return 404 if group not found
  âœ“ Should not expose sensitive tokens in response

describe("PUT /api/groups/[groupId]")
  âœ“ Should update group name (200)
  âœ“ Should update budget
  âœ“ Should update end date
  âœ“ Should update multiple fields
  âœ“ Should require authentication (401)
  âœ“ Should allow only creator (403)
  âœ“ Should validate budget > 0 (400)
  âœ“ Should validate end date in future (400)
  âœ“ Should reject updates after draw (400)
  âœ“ Should return 404 if group not found
  âœ“ Should sanitize input data

describe("DELETE /api/groups/[groupId]")
  âœ“ Should delete group and cascade (200)
  âœ“ Should require authentication (401)
  âœ“ Should allow only creator (403)
  âœ“ Should require confirmation param (400)
  âœ“ Should return 404 if group not found
  âœ“ Should handle database cascade errors
```

---

#### 2.3. /api/auth/* endpoints (4 endpoints)
**Dlaczego:** Security layer - juÅ¼ sÄ… handlery, ale nie testy API

**Testy do dodania (~40-50 testÃ³w):**

```typescript
describe("POST /api/auth/login")
  // Success
  âœ“ Should login with valid credentials (200)
  âœ“ Should return JWT token
  âœ“ Should set session cookie
  âœ“ Should return user info (without password)

  // Validation
  âœ“ Should require email (400)
  âœ“ Should require password (400)
  âœ“ Should validate email format (400)

  // Authentication errors
  âœ“ Should reject invalid email (401)
  âœ“ Should reject invalid password (401)
  âœ“ Should reject non-existent user (401)

  // Security
  âœ“ Should rate limit failed attempts (429)
  âœ“ Should hash passwords in comparison
  âœ“ Should not expose password in error
  âœ“ Should log failed login attempts

  // Edge cases
  âœ“ Should trim whitespace from email
  âœ“ Should be case-insensitive for email
  âœ“ Should handle special characters in password

describe("POST /api/auth/register")
  // Success
  âœ“ Should register new user (201)
  âœ“ Should return JWT token
  âœ“ Should hash password before saving
  âœ“ Should create user record

  // Validation
  âœ“ Should require email (400)
  âœ“ Should require password (400)
  âœ“ Should validate email format (400)
  âœ“ Should validate password length (400)
  âœ“ Should validate password complexity (400)
  âœ“ Should require terms acceptance (400)

  // Duplicate handling
  âœ“ Should reject duplicate email (409)
  âœ“ Should be case-insensitive for duplicates

  // Security
  âœ“ Should not expose password in response
  âœ“ Should rate limit registrations (429)

  // Edge cases
  âœ“ Should trim email whitespace
  âœ“ Should handle long email addresses

describe("POST /api/auth/logout")
  âœ“ Should clear session (200)
  âœ“ Should invalidate JWT token
  âœ“ Should work without session (200)
  âœ“ Should redirect to login page

describe("POST /api/auth/reset-password")
  // Success
  âœ“ Should send reset email (200)
  âœ“ Should generate reset token
  âœ“ Should set token expiry (1 hour)

  // Validation
  âœ“ Should require email (400)
  âœ“ Should validate email format (400)

  // Not found
  âœ“ Should return success even if user not found (security)
  âœ“ Should not expose user existence

  // Security
  âœ“ Should rate limit reset requests (429)
  âœ“ Should use secure token generation
  âœ“ Should invalidate old tokens
```

---

#### 2.4. Remaining endpoints (~50-60 testÃ³w)

**Participants endpoints:**
```typescript
describe("GET /api/participants/[participantId]")
  âœ“ Should return participant details
  âœ“ Should validate access (token or user_id)
  âœ“ Should return 403 if unauthorized
  âœ“ Should return 404 if not found

describe("PUT /api/participants/[participantId]")
  âœ“ Should update participant
  âœ“ Should allow only creator
  âœ“ Should validate email uniqueness
  âœ“ Should reject after draw

describe("POST /api/participants/[participantId]/wishlist")
  âœ“ Should create/update wishlist
  âœ“ Should validate access
  âœ“ Should check end date
  âœ“ Should handle long content

describe("GET /api/participants/[participantId]/reveal")
  âœ“ Should reveal assignment
  âœ“ Should validate access
  âœ“ Should check if drawn
  âœ“ Should track reveal timestamp
```

**Groups endpoints:**
```typescript
describe("GET /api/groups")
  âœ“ Should list user's groups
  âœ“ Should require authentication
  âœ“ Should include created groups
  âœ“ Should include participant groups
  âœ“ Should paginate results

describe("POST /api/groups")
  âœ“ Should create new group
  âœ“ Should auto-add creator
  âœ“ Should validate input
  âœ“ Should require authentication

describe("GET /api/groups/[groupId]/participants")
  âœ“ Should list participants
  âœ“ Should validate access
  âœ“ Should not expose tokens

describe("POST /api/groups/[groupId]/participants")
  âœ“ Should add participant
  âœ“ Should allow only creator
  âœ“ Should validate email uniqueness
  âœ“ Should reject after draw

describe("GET /api/groups/[groupId]/exclusions")
  âœ“ Should list exclusions
  âœ“ Should validate access

describe("POST /api/groups/[groupId]/exclusions")
  âœ“ Should add exclusion
  âœ“ Should allow only creator
  âœ“ Should validate participants
  âœ“ Should check draw possibility
```

**Exclusions endpoints:**
```typescript
describe("DELETE /api/exclusions/[id]")
  âœ“ Should delete exclusion
  âœ“ Should allow only creator
  âœ“ Should reject after draw
  âœ“ Should return 404 if not found
```

**Results endpoints:**
```typescript
describe("GET /api/results/[token]")
  âœ“ Should return result for valid token
  âœ“ Should validate token
  âœ“ Should check if drawn
  âœ“ Should return giver info
  âœ“ Should return receiver info with wishlist
  âœ“ Should return 404 for invalid token

describe("POST /api/results/[token]/track")
  âœ“ Should track result view
  âœ“ Should save timestamp
  âœ“ Should save IP (optional)
  âœ“ Should increment view count
```

---

### **Oszacowanie Fazy 2:**
- **Liczba testÃ³w:** 135-165 testÃ³w
- **Czas realizacji:** 3-4 godziny
- **Pliki:** 17 API endpoints
- **Linii kodu testowanego:** ~1,200 LOC
- **Pokrycie po fazie:** API 0% â†’ 100%

**Struktura plikÃ³w testowych:**
```
src/pages/api/__tests__/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ login.test.ts        (~15 tests)
â”‚   â”œâ”€â”€ register.test.ts     (~18 tests)
â”‚   â”œâ”€â”€ logout.test.ts       (~5 tests)
â”‚   â””â”€â”€ reset-password.test.ts (~12 tests)
â”œâ”€â”€ groups/
â”‚   â”œâ”€â”€ index.test.ts        (~15 tests)
â”‚   â”œâ”€â”€ [groupId]/
â”‚   â”‚   â”œâ”€â”€ index.test.ts    (~25 tests)
â”‚   â”‚   â”œâ”€â”€ draw.test.ts     (~30 tests)
â”‚   â”‚   â”œâ”€â”€ participants.test.ts (~15 tests)
â”‚   â”‚   â”œâ”€â”€ exclusions.test.ts (~10 tests)
â”‚   â”‚   â””â”€â”€ result.test.ts   (~10 tests)
â”œâ”€â”€ participants/
â”‚   â””â”€â”€ [participantId]/
â”‚       â”œâ”€â”€ index.test.ts    (~10 tests)
â”‚       â”œâ”€â”€ wishlist.test.ts (~12 tests)
â”‚       â””â”€â”€ reveal.test.ts   (~8 tests)
â”œâ”€â”€ exclusions/
â”‚   â””â”€â”€ [id].test.ts         (~8 tests)
â””â”€â”€ results/
    â””â”€â”€ [token]/
        â”œâ”€â”€ index.test.ts    (~10 tests)
        â””â”€â”€ track.test.ts    (~7 tests)
```

**Testing utilities to create:**
```typescript
// src/pages/api/__tests__/utils/testHelpers.ts
export const createMockRequest = (options) => { /* ... */ };
export const createMockResponse = () => { /* ... */ };
export const mockAuthSession = (userId) => { /* ... */ };
export const mockDatabase = () => { /* ... */ };
```

---

## **FAZA 3: HOOKS + KOMPONENTY** âš›ï¸
**Priorytet:** ÅšREDNI
**Czas:** 6-8 godzin
**WpÅ‚yw:** UX + RELIABILITY

### 3.1. Critical Hooks (~80-100 testÃ³w)

#### useDraw.ts (92 LOC) - 15-20 testÃ³w
**Dlaczego:** Orkiestruje caÅ‚y proces losowania

```typescript
describe("useDraw")
  âœ“ Should initialize with default state
  âœ“ Should validate draw before execution
  âœ“ Should call API /groups/[id]/draw
  âœ“ Should handle success response
  âœ“ Should update group state after draw
  âœ“ Should handle validation errors (< 3 participants)
  âœ“ Should handle impossible exclusions
  âœ“ Should handle already drawn error
  âœ“ Should handle timeout errors
  âœ“ Should handle network errors
  âœ“ Should set loading states correctly
  âœ“ Should show success notification
  âœ“ Should show error notification
  âœ“ Should retry on failure (optional)
  âœ“ Should cleanup on unmount
```

#### useGroupViewHandlers.ts (169 LOC) - 20-25 testÃ³w
```typescript
describe("useGroupViewHandlers")
  // Participant handlers
  âœ“ Should handle add participant
  âœ“ Should handle edit participant
  âœ“ Should handle delete participant
  âœ“ Should validate participant data

  // Exclusion handlers
  âœ“ Should handle add exclusion
  âœ“ Should handle delete exclusion
  âœ“ Should validate exclusion rules

  // Group handlers
  âœ“ Should handle edit group
  âœ“ Should handle delete group
  âœ“ Should require confirmation for delete

  // Draw handlers
  âœ“ Should handle draw execution
  âœ“ Should validate before draw

  // Modal states
  âœ“ Should toggle modals correctly
  âœ“ Should manage loading states

  // Error handling
  âœ“ Should handle API errors
  âœ“ Should show notifications
```

#### useResultData.ts (239 LOC) - 20-25 testÃ³w
```typescript
describe("useResultData")
  // Data fetching
  âœ“ Should fetch result by token
  âœ“ Should fetch result by participant ID
  âœ“ Should handle loading state
  âœ“ Should handle error state
  âœ“ Should cache fetched data

  // Access validation
  âœ“ Should validate token
  âœ“ Should check if group is drawn
  âœ“ Should validate user access

  // Data transformation
  âœ“ Should parse giver data
  âœ“ Should parse receiver data
  âœ“ Should include wishlist
  âœ“ Should include group info

  // Error scenarios
  âœ“ Should handle invalid token
  âœ“ Should handle not drawn yet
  âœ“ Should handle network errors
  âœ“ Should handle 404 errors

  // Tracking
  âœ“ Should track result view
  âœ“ Should increment view count
```

#### useTokenVerification.ts (121 LOC) - 15-20 testÃ³w
```typescript
describe("useTokenVerification")
  // PKCE flow
  âœ“ Should verify PKCE code
  âœ“ Should exchange code for session
  âœ“ Should handle code parameter from URL

  // Implicit flow
  âœ“ Should verify access token
  âœ“ Should set session with token
  âœ“ Should handle token from hash

  // Existing session
  âœ“ Should check existing session first
  âœ“ Should skip verification if session valid

  // Error handling
  âœ“ Should handle expired token
  âœ“ Should handle invalid token
  âœ“ Should handle network errors

  // States
  âœ“ Should set loading state
  âœ“ Should set error state
  âœ“ Should set valid state
```

#### useWishlistEditor.ts (257 LOC) - 25-30 testÃ³w
```typescript
describe("useWishlistEditor")
  // Initialization
  âœ“ Should load existing wishlist
  âœ“ Should initialize with empty content
  âœ“ Should set loading state

  // Editing
  âœ“ Should handle content changes
  âœ“ Should debounce auto-save
  âœ“ Should detect URL links
  âœ“ Should format URLs as clickable
  âœ“ Should handle long content (10k+ chars)

  // Saving
  âœ“ Should auto-save after 2 seconds
  âœ“ Should manual save on blur
  âœ“ Should show save status
  âœ“ Should handle save errors
  âœ“ Should retry failed saves

  // Validation
  âœ“ Should check end date before save
  âœ“ Should reject after end date
  âœ“ Should validate access (token/user)

  // Access control
  âœ“ Should allow edit with valid token
  âœ“ Should allow edit for registered user
  âœ“ Should reject without auth

  // Read-only mode
  âœ“ Should disable editing after end date
  âœ“ Should show read-only message

  // Edge cases
  âœ“ Should handle concurrent edits
  âœ“ Should preserve content on error
  âœ“ Should cleanup on unmount
```

### 3.2. Group Components (~100-120 testÃ³w)

**Top priority components:**

#### GroupView.tsx (215 LOC) - 15-20 testÃ³w
```typescript
describe("GroupView")
  // Rendering
  âœ“ Should render group header
  âœ“ Should render participants section
  âœ“ Should render exclusions section
  âœ“ Should render draw section
  âœ“ Should render results section if drawn

  // States
  âœ“ Should show loading state
  âœ“ Should show error state
  âœ“ Should show not found state

  // Authorization
  âœ“ Should show creator actions to creator
  âœ“ Should hide creator actions to participants

  // Draw status
  âœ“ Should show pre-draw UI if not drawn
  âœ“ Should show post-draw UI if drawn
  âœ“ Should disable editing after draw

  // Interactions
  âœ“ Should open modals on button click
  âœ“ Should refresh data after mutations
```

#### ParticipantCard.tsx (282 LOC) - 15-20 testÃ³w
```typescript
describe("ParticipantCard")
  // Rendering
  âœ“ Should display participant name
  âœ“ Should display email if registered
  âœ“ Should show registered badge
  âœ“ Should show unregistered badge
  âœ“ Should show creator badge

  // Actions
  âœ“ Should show edit button to creator
  âœ“ Should show delete button to creator
  âœ“ Should hide actions to non-creator
  âœ“ Should disable actions after draw

  // Interactions
  âœ“ Should open edit modal
  âœ“ Should open delete modal
  âœ“ Should confirm before delete

  // States
  âœ“ Should show loading during mutation
  âœ“ Should show error state
```

#### AddExclusionForm.tsx (239 LOC) - 15-20 testÃ³w
```typescript
describe("AddExclusionForm")
  // Rendering
  âœ“ Should render giver select
  âœ“ Should render receiver select
  âœ“ Should populate dropdowns with participants
  âœ“ Should show submit button

  // Validation
  âœ“ Should require giver selection
  âœ“ Should require receiver selection
  âœ“ Should prevent same giver and receiver
  âœ“ Should check for duplicates
  âœ“ Should validate draw possibility

  // Submission
  âœ“ Should call API on submit
  âœ“ Should show loading state
  âœ“ Should show success message
  âœ“ Should clear form after success
  âœ“ Should show error message on failure

  // Edge cases
  âœ“ Should disable if only 2 participants
  âœ“ Should show warning if many exclusions
```

#### DrawSection.tsx (144 LOC) - 10-15 testÃ³w
```typescript
describe("DrawSection")
  // Rendering
  âœ“ Should show participant count
  âœ“ Should show exclusion rules count
  âœ“ Should show draw button
  âœ“ Should show validation errors

  // Validation
  âœ“ Should disable if < 3 participants
  âœ“ Should disable if impossible exclusions
  âœ“ Should show validation messages

  // Draw execution
  âœ“ Should confirm before draw
  âœ“ Should call draw API
  âœ“ Should show loading during draw
  âœ“ Should show success message
  âœ“ Should redirect to results

  // Error handling
  âœ“ Should show error message on failure
  âœ“ Should handle timeout errors
```

**Additional components (estimate only):**
- ParticipantsList.tsx - 15-20 testÃ³w
- GroupEditModal.tsx - 10-15 testÃ³w
- AddParticipantForm.tsx - 15-20 testÃ³w
- EditParticipantModal.tsx - 10-15 testÃ³w
- DeleteGroupModal.tsx - 8-10 testÃ³w
- DeleteParticipantModal.tsx - 8-10 testÃ³w

### 3.3. Result Components (~60-80 testÃ³w)

#### WishlistEditor.tsx (245 LOC) - 15-20 testÃ³w
```typescript
describe("WishlistEditor")
  // Rendering
  âœ“ Should render textarea
  âœ“ Should show character count
  âœ“ Should show save status
  âœ“ Should render URLs as links

  // Editing
  âœ“ Should allow text input
  âœ“ Should handle paste events
  âœ“ Should detect URLs
  âœ“ Should auto-save after delay

  // Read-only mode
  âœ“ Should disable after end date
  âœ“ Should show disabled message

  // Validation
  âœ“ Should check max length
  âœ“ Should validate access

  // Edge cases
  âœ“ Should handle very long content
  âœ“ Should handle many URLs
  âœ“ Should preserve content on blur
```

#### ResultReveal.tsx (156 LOC) - 10-15 testÃ³w
```typescript
describe("ResultReveal")
  // Animation
  âœ“ Should show gift box animation
  âœ“ Should play reveal animation
  âœ“ Should show confetti on reveal

  // Content
  âœ“ Should reveal receiver name
  âœ“ Should show receiver wishlist
  âœ“ Should show group info

  // Interactions
  âœ“ Should reveal on button click
  âœ“ Should track reveal timestamp
  âœ“ Should disable during animation

  // States
  âœ“ Should show loading state
  âœ“ Should handle error state
```

**Additional components:**
- ResultView.tsx - 10-15 testÃ³w
- ResultHeader.tsx - 10-15 testÃ³w
- WishlistDisplay.tsx - 10-15 testÃ³w
- AssignedPersonCard.tsx - 8-10 testÃ³w

---

### **Oszacowanie Fazy 3:**
- **Liczba testÃ³w:** 240-300 testÃ³w
- **Czas realizacji:** 6-8 godzin
- **Pliki:** 20 hookÃ³w + 15 komponentÃ³w
- **Linii kodu testowanego:** ~3,500 LOC
- **Pokrycie po fazie:**
  - Hooks 0% â†’ 100%
  - Components 10% â†’ 60%

---

## **FAZA 4: UTILITIES + VALIDATORS** ğŸ”§
**Priorytet:** NISKI
**Czas:** 3-4 godziny
**WpÅ‚yw:** QUALITY OF LIFE

### 4.1. Utility Functions (~40-50 testÃ³w)

#### formatters.ts (~150 LOC) - 15-20 testÃ³w
```typescript
describe("formatters")
  describe("formatDate")
    âœ“ Should format date to Polish locale
    âœ“ Should handle ISO strings
    âœ“ Should handle Date objects
    âœ“ Should handle invalid dates

  describe("formatCurrency")
    âœ“ Should format PLN correctly
    âœ“ Should add currency symbol
    âœ“ Should handle decimals
    âœ“ Should handle large numbers

  describe("formatParticipantName")
    âœ“ Should show "(You)" for current user
    âœ“ Should show plain name for others
    âœ“ Should handle long names

  describe("formatRelativeTime")
    âœ“ Should show "just now" for recent
    âœ“ Should show "5 minutes ago"
    âœ“ Should show "2 hours ago"
    âœ“ Should show date for old items
```

#### validators.ts (~80 LOC) - 10-15 testÃ³w
```typescript
describe("validators")
  describe("isValidEmail")
    âœ“ Should validate correct emails
    âœ“ Should reject invalid formats
    âœ“ Should be case-insensitive

  describe("isValidBudget")
    âœ“ Should accept positive numbers
    âœ“ Should reject zero
    âœ“ Should reject negative
    âœ“ Should reject non-numbers

  describe("isValidEndDate")
    âœ“ Should accept future dates
    âœ“ Should reject past dates
    âœ“ Should handle today's date

  describe("isValidParticipantName")
    âœ“ Should accept 2-100 characters
    âœ“ Should reject too short names
    âœ“ Should reject empty strings
```

#### api-auth.utils.ts (~100 LOC) - 10-15 testÃ³w
```typescript
describe("api-auth.utils")
  describe("getSessionUser")
    âœ“ Should extract user from session
    âœ“ Should return null if no session
    âœ“ Should validate JWT token

  describe("requireAuth")
    âœ“ Should allow authenticated requests
    âœ“ Should reject unauthenticated (401)
    âœ“ Should check token expiry

  describe("requireGroupCreator")
    âœ“ Should allow creator
    âœ“ Should reject non-creator (403)
    âœ“ Should check group ownership

  describe("requireGroupMember")
    âœ“ Should allow member
    âœ“ Should reject non-member (403)
    âœ“ Should check participant list
```

#### token.utils.ts (~22 LOC) - 5-8 testÃ³w
```typescript
describe("token.utils")
  describe("generateSecureToken")
    âœ“ Should generate 32+ character token
    âœ“ Should use URL-safe characters
    âœ“ Should be cryptographically secure
    âœ“ Should generate unique tokens
    âœ“ Should have high entropy
```

#### clipboard.ts (~30 LOC) - 5-8 testÃ³w
```typescript
describe("clipboard")
  describe("copyToClipboard")
    âœ“ Should copy text to clipboard
    âœ“ Should use modern API if available
    âœ“ Should fallback to execCommand
    âœ“ Should handle copy errors
    âœ“ Should show success notification

  describe("copyGroupLink")
    âœ“ Should copy full group URL
    âœ“ Should include participant token
```

### 4.2. Schemas (~20-25 testÃ³w)

#### group.schemas.ts (~32 LOC) - 15-20 testÃ³w
```typescript
describe("groupFormSchema")
  describe("name validation")
    âœ“ Should require name
    âœ“ Should accept 3-100 characters
    âœ“ Should reject too short names
    âœ“ Should reject too long names
    âœ“ Should trim whitespace

  describe("budget validation")
    âœ“ Should require budget
    âœ“ Should accept positive numbers
    âœ“ Should reject zero
    âœ“ Should reject negative
    âœ“ Should accept decimals

  describe("end_date validation")
    âœ“ Should require end date
    âœ“ Should accept future dates
    âœ“ Should reject past dates
    âœ“ Should parse ISO strings

  describe("SafeParse")
    âœ“ Should return success for valid data
    âœ“ Should return errors for invalid data
```

#### dateValidators.ts (~30 LOC) - 5-10 testÃ³w
```typescript
describe("dateValidators")
  describe("isAfterToday")
    âœ“ Should return true for future dates
    âœ“ Should return false for past dates
    âœ“ Should handle today correctly

  describe("isSameDay")
    âœ“ Should compare dates by day only
    âœ“ Should ignore time component

  describe("parseEndDate")
    âœ“ Should parse ISO strings
    âœ“ Should handle Date objects
    âœ“ Should return null for invalid
```

---

### **Oszacowanie Fazy 4:**
- **Liczba testÃ³w:** 60-75 testÃ³w
- **Czas realizacji:** 3-4 godziny
- **Pliki:** 7 plikÃ³w (5 utils + 2 schemas)
- **Linii kodu testowanego:** ~450 LOC
- **Pokrycie po fazie:**
  - Utils 20% â†’ 100%
  - Schemas 40% â†’ 100%

---

## ğŸ“Š PODSUMOWANIE CAÅEGO PLANU

### Zestawienie wszystkich faz:

| Faza | Kategoria | Liczba testÃ³w | Czas | Priorytet | LOC testowany |
|------|-----------|---------------|------|-----------|---------------|
| **1** | Services | 150-175 | 3-4h | CRITICAL | ~2,100 |
| **2** | API Endpoints | 135-165 | 3-4h | HIGH | ~1,200 |
| **3** | Hooks + Components | 240-300 | 6-8h | MEDIUM | ~3,500 |
| **4** | Utils + Validators | 60-75 | 3-4h | LOW | ~450 |
| **Subtotal** | **Nowe testy** | **585-715** | **15-20h** | - | **~7,250** |
| **Existing** | **Auth (done)** | **439** | - | - | - |
| **TOTAL** | **Wszystkie** | **1,024-1,154** | - | - | **~7,250** |

### Pokrycie testami - przed i po:

| Kategoria | Przed | Po Fazie | Cel koÅ„cowy |
|-----------|-------|----------|-------------|
| Auth | 100% âœ… | 100% | 100% |
| Services | 14% | 100% | 100% |
| API Endpoints | 0% | 100% | 100% |
| Hooks | 0% | 100% | 100% |
| Components | 10% | 60% | 60-70% |
| Utils | 20% | 100% | 100% |
| Schemas | 40% | 100% | 100% |
| **OVERALL** | **~15-20%** | **85-90%** | **85-90%** |

---

## ğŸ¯ REKOMENDACJE

### KolejnoÅ›Ä‡ wykonania (najbardziej optymalna):

1. **START: Faza 1 (Services)** - 3-4h
   - Natychmiastowy wpÅ‚yw na jakoÅ›Ä‡
   - Testuje core business logic
   - Wykryje krytyczne bugi

2. **Faza 2 (API Endpoints)** - 3-4h
   - Security testing
   - Contract testing
   - Integration validation

3. **Faza 3A (Critical Hooks)** - 3-4h
   - useDraw, useGroupViewHandlers, useResultData
   - Testuje user workflows
   - NajwiÄ™kszy wpÅ‚yw na UX

4. **Faza 3B (Group Components)** - 2-3h
   - GroupView, ParticipantCard, DrawSection
   - UI/UX validation

5. **Faza 4 (Utils + Validators)** - 2-3h
   - Quality of life improvements
   - Edge case handling

6. **OPTIONAL: Faza 3C (Remaining Components)** - 2-3h
   - Lower priority components
   - Nice to have

### Priorytety jeÅ›li ograniczony czas:

**Minimum viable (8-10h):**
- Faza 1: Services (4h)
- Faza 2: Critical API endpoints (4h)
  - /groups/[groupId]/draw
  - /groups/[groupId]/index
  - /auth/*

**Recommended (15-20h):**
- Wszystkie 4 fazy

**Comprehensive (20-25h):**
- Wszystkie 4 fazy + remaining components

---

## ğŸ“ TEMPLATE PLIKU TESTOWEGO

### PrzykÅ‚adowa struktura testu dla serwisu:

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from "vitest";
import { serviceName } from "../service-name";
import { mockDatabase } from "@/test-utils/mockDatabase";

describe("ServiceName", () => {
  let mockDb: ReturnType<typeof mockDatabase>;

  beforeEach(() => {
    mockDb = mockDatabase();
    vi.clearAllMocks();
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  describe("methodName", () => {
    describe("Success scenarios", () => {
      it("should handle basic case", async () => {
        // Arrange
        const input = { /* ... */ };
        mockDb.table.select.mockResolvedValue([/* mock data */]);

        // Act
        const result = await serviceName.methodName(input);

        // Assert
        expect(result).toEqual(/* expected */);
        expect(mockDb.table.select).toHaveBeenCalledWith(/* ... */);
      });
    });

    describe("Error scenarios", () => {
      it("should throw error when validation fails", async () => {
        // Arrange
        const invalidInput = { /* ... */ };

        // Act & Assert
        await expect(
          serviceName.methodName(invalidInput)
        ).rejects.toThrow("Expected error message");
      });
    });

    describe("Edge cases", () => {
      it("should handle edge case X", async () => {
        // Test implementation
      });
    });
  });
});
```

### PrzykÅ‚adowa struktura testu dla API endpoint:

```typescript
import { describe, it, expect, vi, beforeEach } from "vitest";
import { GET, POST, PUT, DELETE } from "../endpoint";
import { mockRequest, mockResponse } from "@/test-utils/apiHelpers";
import { mockAuthSession } from "@/test-utils/authHelpers";

describe("API: /api/resource/[id]", () => {
  let req: ReturnType<typeof mockRequest>;
  let res: ReturnType<typeof mockResponse>;

  beforeEach(() => {
    req = mockRequest();
    res = mockResponse();
    vi.clearAllMocks();
  });

  describe("GET /api/resource/[id]", () => {
    it("should return resource (200)", async () => {
      // Arrange
      mockAuthSession("user-123");
      req.query = { id: "1" };

      // Act
      await GET(req, res);

      // Assert
      expect(res.status).toHaveBeenCalledWith(200);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({ id: 1 })
      );
    });

    it("should require authentication (401)", async () => {
      // Act
      await GET(req, res);

      // Assert
      expect(res.status).toHaveBeenCalledWith(401);
    });
  });
});
```

---

## ğŸ“š RESOURCES

### Testing utilities do utworzenia:

```typescript
// src/test-utils/mockDatabase.ts
export function mockDatabase() {
  return {
    groups: {
      select: vi.fn(),
      insert: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
    },
    participants: {
      select: vi.fn(),
      insert: vi.fn(),
      // ...
    },
    // ...
  };
}

// src/test-utils/apiHelpers.ts
export function mockRequest(overrides = {}) {
  return {
    method: 'GET',
    query: {},
    body: {},
    headers: {},
    ...overrides,
  };
}

export function mockResponse() {
  const res: any = {};
  res.status = vi.fn().mockReturnValue(res);
  res.json = vi.fn().mockReturnValue(res);
  res.send = vi.fn().mockReturnValue(res);
  return res;
}

// src/test-utils/authHelpers.ts
export function mockAuthSession(userId: string) {
  vi.mock("@/lib/auth/session", () => ({
    getSession: vi.fn().mockResolvedValue({
      user: { id: userId }
    })
  }));
}

// src/test-utils/fixtures.ts
export const mockGroup = { /* ... */ };
export const mockParticipant = { /* ... */ };
export const mockExclusion = { /* ... */ };
```

### Documentation references:

- **Vitest**: https://vitest.dev/
- **React Testing Library**: https://testing-library.com/react
- **Testing Best Practices**: /home/user/secret-santa/CLAUDE.md (TESTING section)
- **Existing Auth Tests**: src/components/auth/__tests__/ (jako wzorzec)

---

## âœ… DEFINITION OF DONE

Test jest uznany za "done" gdy:

1. âœ… Wszystkie scenariusze success/error pokryte
2. âœ… Edge cases zidentyfikowane i przetestowane
3. âœ… Testy przechodzÄ… (green)
4. âœ… Coverage > 80% dla pliku
5. âœ… Brak flaky tests (deterministyczne)
6. âœ… Testy dziaÅ‚ajÄ… w CI/CD
7. âœ… Dokumentacja (komentarze w testach)
8. âœ… Czytelne nazwy testÃ³w (describe/it)

---

## ğŸš€ NASTÄ˜PNE KROKI

1. **Review tego planu** z zespoÅ‚em
2. **Zatwierdzenie priorytetÃ³w** i timeline
3. **RozpoczÄ™cie Fazy 1** - draw.service.ts
4. **Daily progress tracking** - TODO list per faza
5. **Code review** po kaÅ¼dej fazie
6. **Merge do develop** po zakoÅ„czeniu fazy

---

**Dokument stworzony:** 6 listopada 2025
**Autor:** AI Test Specialist
**Wersja:** 1.0
**Status:** Zaplanowane - oczekuje na rozpoczÄ™cie

---

## ğŸ“ KONTAKT / PYTANIA

JeÅ›li masz pytania dotyczÄ…ce tego planu:
- Skonsultuj z project owner
- Przejrzyj istniejÄ…ce testy auth jako wzorzec
- Zobacz CLAUDE.md dla testing guidelines

**Powodzenia w testowaniu! ğŸ¯**
