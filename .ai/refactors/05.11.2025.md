# Analiza z≈Ço≈ºono≈õci hook√≥w - 05.11.2025

## Executive Summary

Przeanalizowano wszystkie pliki w folderze `src/hooks/` identyfikujƒÖc TOP 5 plik√≥w o najwiƒôkszej liczbie linii kodu (LOC) i potencjalnie wysokiej z≈Ço≈ºono≈õci. Dla ka≈ºdego z nich zaproponowano konkretne kierunki refaktoryzacji z wykorzystaniem wzorc√≥w projektowych i technik dopasowanych do stack technologicznego projektu (React 19, TypeScript, Vitest).

---

## 1. TOP 5 plik√≥w o najwiƒôkszej liczbie LOC

### Ranking (malejƒÖco):

| #  | Plik                          | LOC | Ocena z≈Ço≈ºono≈õci |
|----|-------------------------------|-----|------------------|
| 1  | `useWishlistEditor.ts`        | 258 | ‚ö†Ô∏è Bardzo wysoka  |
| 2  | `useResultData.ts`            | 240 | ‚ö†Ô∏è Bardzo wysoka  |
| 3  | `useGroupViewHandlers.ts`     | 170 | ‚ö†Ô∏è Wysoka         |
| 4  | `useGroupViewModel.ts`        | 135 | ‚ö†Ô∏è ≈örednia        |
| 5  | `useTokenVerification.ts`     | 122 | ‚ö†Ô∏è ≈örednia        |

---

## 2. Szczeg√≥≈Çowa analiza i propozycje refaktoryzacji

### 1Ô∏è‚É£ useWishlistEditor.ts (258 linii)

**Lokalizacja:** `/home/user/secret-santa/src/hooks/useWishlistEditor.ts`

#### üî¥ Zidentyfikowane problemy:

1. **Zbyt wiele odpowiedzialno≈õci (God Hook)** - ≈ÇƒÖczy edycjƒô, walidacjƒô, zapisywanie, debouncing, state management
2. **≈öci≈õle powiƒÖzany z API** - bezpo≈õrednie wywo≈Çania fetch naruszajƒÖ separacjƒô warstw
3. **Duplikacja logiki** - funkcje formatowania duplikowane z innych hook√≥w
4. **Zbyt skomplikowana obs≈Çuga b≈Çƒôd√≥w** - d≈Çuga seria switch/case (linie 133-152)

#### ‚úÖ Propozycje refaktoryzacji:

**A) Service Layer Pattern** (Priorytet: üî• WYSOKI)
- Wydzieliƒá `services/wishlistService.ts` z fetch logic
- Hook u≈ºywa serwisu zamiast bezpo≈õrednio fetch
- Korzy≈õci: lepsza testowalno≈õƒá, separacja warstw, reu≈ºywalno≈õƒá

**B) Wydzielenie hooka useAutosave** (Priorytet: üü° ≈öREDNI)
- Reu≈ºywalny hook dla autosave z debounce
- Redukcja ~40 linii w useWishlistEditor

**C) Custom Error Types z Type Guards** (Priorytet: üü° ≈öREDNI)
- `types/wishlistErrors.ts` z enum i klasƒÖ WishlistError
- Type-safe error handling eliminuje switch/case

**D) React Query** (Priorytet: üîµ NISKI - wymaga nowej zale≈ºno≈õci)
- Eliminuje boilerplate state management
- Wbudowane retry, cache, optimistic updates

---

### 2Ô∏è‚É£ useResultData.ts (240 linii)

**Lokalizacja:** `/home/user/secret-santa/src/hooks/useResultData.ts`

#### üî¥ Zidentyfikowane problemy:

1. **Hook jako "God Object"** - 12 pomocniczych funkcji formatujƒÖcych
2. **Naruszenie DRY** - funkcje powielone w 3+ hookach
3. **Mixing concerns** - transformacja + formatowanie + API calls razem
4. **Zbyt rozbudowana transformToViewModel** - 40+ linii

#### ‚úÖ Propozycje refaktoryzacji:

**A) Centralizacja format√≥w w utils** (Priorytet: üî• WYSOKI - Quick Win)
- Rozszerzyƒá `lib/utils/formatters.ts` o wszystkie formattery
- Eliminacja duplikacji w 4+ hookach
- Redukcja ~140 linii w sumie

**B) Wydzielenie ViewModels** (Priorytet: üü° ≈öREDNI)
- `viewModels/resultViewModel.ts` jako pure function
- Separacja transformacji od logiki hooka
- Testowalne bez React

**C) React Query** (Priorytet: üîµ NISKI)
- Redukcja ~100 linii boilerplate
- Wymaga @tanstack/react-query

---

### 3Ô∏è‚É£ useGroupViewHandlers.ts (170 linii)

**Lokalizacja:** `/home/user/secret-santa/src/hooks/useGroupViewHandlers.ts`

#### üî¥ Zidentyfikowane problemy:

1. **Facade Pattern gone wrong** - 17 prostych przeka≈∫nik√≥w
2. **Tight coupling** - zale≈ºno≈õƒá od useModalState i konkretnych refetch
3. **Low cohesion** - mieszane domeny (grupa, uczestnicy, wykluczenia, losowanie)
4. **Naruszenie SRP** - zbyt wiele odpowiedzialno≈õci

#### ‚úÖ Propozycje refaktoryzacji:

**A) Podzia≈Ç na tematyczne hooki** (Priorytet: üî• WYSOKI)
- `hooks/group/useGroupHandlers.ts` (~30 linii)
- `hooks/group/useParticipantHandlers.ts` (~70 linii)
- `hooks/group/useExclusionHandlers.ts` (~40 linii)
- `hooks/group/useDrawHandlers.ts` (~30 linii)
- Korzy≈õci: SRP, ≈Çatwiejsze testy, mo≈ºliwo≈õƒá u≈ºycia tylko potrzebnych

**B) useOptimistic na poziomie hooka** (Priorytet: üü° ≈öREDNI)
- Konsolidacja logiki optimistic updates
- Zgodne z React 19 best practices

---

### 4Ô∏è‚É£ useGroupViewModel.ts (135 linii)

**Lokalizacja:** `/home/user/secret-santa/src/hooks/useGroupViewModel.ts`

#### üî¥ Zidentyfikowane problemy:

1. **Ciƒô≈ºkie obliczenia w useMemo** - przeliczanie wszystkich ViewModels przy ka≈ºdej zmianie
2. **Duplikacja formatowania** - powtarza funkcje z innych hook√≥w
3. **N+1 problem** - ka≈ºdy uczestnik mapowany z dostƒôpem do ca≈Çego group

#### ‚úÖ Propozycje refaktoryzacji:

**A) Fine-grained memoization** (Priorytet: üü° ≈öREDNI)
- Per-entity memoization z useCallback
- ~30% poprawa performance przy >10 uczestnikach

**B) ViewModels jako klasy** (Priorytet: üîµ NISKI)
- Lazy evaluation getter√≥w
- Wymaga zmiany paradygmatu (FP ‚Üí OOP)

---

### 5Ô∏è‚É£ useTokenVerification.ts (122 linie)

**Lokalizacja:** `/home/user/secret-santa/src/hooks/useTokenVerification.ts`

#### üî¥ Zidentyfikowane problemy:

1. **Skomplikowana logika** - 3 r√≥≈ºne ≈õcie≈ºki (session, PKCE, implicit)
2. **Side effects w useEffect** - manipulacja window.location
3. **Tight coupling z Supabase** - niemo≈ºliwe do przetestowania
4. **Zagnie≈ºd≈ºone if-y** - linie 59-104

#### ‚úÖ Propozycje refaktoryzacji:

**A) Strategy Pattern** (Priorytet: üî• WYSOKI)
- `strategies/PKCEFlowStrategy.ts`
- `strategies/ImplicitFlowStrategy.ts`
- `strategies/ExistingSessionStrategy.ts`
- Eliminacja zagnie≈ºd≈ºonych if-√≥w, ≈Çatwiejsze testy

**B) Dependency Injection** (Priorytet: üü° ≈öREDNI)
- authClient jako parametr zamiast import
- Dramatyczna poprawa testowalno≈õci

**C) URL parsing utils** (Priorytet: üü° ≈öREDNI)
- `lib/utils/urlParser.ts` jako pure function
- Testowalne bez DOM

---

## 3. Plan implementacji

### üî• Faza 1: Quick Wins (1-2 dni)

1. **Centralizacja formatters** (2-4h) - eliminacja duplikacji
2. **Service Layer dla API** (3-5h) - separacja warstw
3. **Podzia≈Ç useGroupViewHandlers** (2-3h) - lepszy SRP
4. **Custom Error Types** (2-3h) - type safety

**Impact:** ~240 linii mniej, +30% test coverage

### üü° Faza 2: Architecture Improvements (3-5 dni)

1. **useAutosave hook** (3-4h) - reu≈ºywalno≈õƒá
2. **ViewModels do plik√≥w** (4-6h) - separacja transformacji
3. **Strategy Pattern auth** (4-5h) - czysta architektura
4. **Dependency Injection** (2-3h) - testowalno≈õƒá
5. **URL parsing utils** (2h) - pure functions
6. **Fine-grained memoization** (3-4h) - performance

**Impact:** ~300 linii mniej, +45% test coverage

### üîµ Faza 3: Advanced (opcjonalnie)

1. **React Query** - wymaga akceptacji (nowa zale≈ºno≈õƒá 52kB)
2. **ViewModels jako klasy** - wymaga zmiany paradygmatu

---

## 4. Metryki

### Przed:
- **Ca≈Çkowite LOC (TOP 5):** 1025
- Duplikacja: ~15%
- Test coverage: ~40%
- Responsibilities: 3-5/hook

### Po (Faza 1+2):
- **Ca≈Çkowite LOC (TOP 5):** ~550 (-46%) ‚úÖ
- Duplikacja: ~3% (-80%) ‚úÖ
- Test coverage: ~75% (+88%) ‚úÖ
- Responsibilities: 1-2/hook (-50%) ‚úÖ

---

## 5. Kluczowe wzorce

1. **Service Layer Pattern** - separacja API od UI
2. **Strategy Pattern** - dla warunkowej logiki
3. **Dependency Injection** - dla testability
4. **Custom Hooks Composition** - ma≈Çe focused hooki
5. **Memoization** - dla performance
6. **ViewModels** - separacja transformacji
7. **Type-safe Errors** - custom error classes
8. **Pure Functions** - ≈Çatwe testowanie

Zgodne z: React 19, TypeScript strict, SOLID, Vitest, DRY

---

## 6. Ryzyka

| Ryzyko | Prawdopodobie≈Ñstwo | Mitygacja |
|--------|-------------------|-----------|
| Breaking changes | ≈örednie | Pe≈Çne testy + E2E |
| Spadek performance | Niskie | Benchmarki + profiling |
| Bundle size ‚Üë | Wysokie (React Query) | Analiza + lazy loading |
| Op√≥r zespo≈Çu | ≈örednie | Faza 3 opcjonalna |

---

**Status:** ‚úÖ Ready for Review
**Data:** 05.11.2025
**Autor:** Claude Code Agent
